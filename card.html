<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AstroFood ‚Äì Carte Digitale (Dark Astral v16.8)</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{ --bg:#0b1220; --paper:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --line:#1f2937; --gold:#FBBF24; --accent:#38bdf8; --radius:16px; --shadow:0 12px 30px rgba(0,0,0,.35); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .wrap{max-width:980px; margin:24px auto; padding:0 16px}

    .card{background:var(--paper); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
    .head{display:flex; gap:16px; align-items:center; justify-content:space-between; padding:18px 22px; border-bottom:1px solid var(--line); background:linear-gradient(180deg, #0f172a, #0c162a 60%)}
    .brand{display:flex; gap:10px; align-items:center}
    .logo{width:38px; height:38px; border-radius:10px; background:conic-gradient(from 0deg, var(--gold), #e8d18b, var(--gold)); display:flex; align-items:center; justify-content:center; color:#111; font-weight:800}
    .title{margin:0}
    .title small{display:block; font-size:.8rem; color:var(--muted)}
    .badges{display:flex; gap:8px; flex-wrap:wrap}
    .badge{border:1px solid var(--line); background:#0b1220; padding:6px 10px; border-radius:999px; font-size:.82rem; color:#cbd5e1}

    .hero{display:grid; grid-template-columns: 140px 1fr 240px; gap:18px; padding:20px 22px; border-bottom:1px solid var(--line)}
    @media (max-width: 860px){ .hero{grid-template-columns:1fr; text-align:left} }
    .thumb{width:100%; aspect-ratio:1/1; border:1px solid var(--line); border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:42px; background:#0b1220}
    .meta{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px}
    .chip{border:1px solid var(--line); background:#0b1220; padding:8px 10px; border-radius:12px; font-size:.9rem}
    .cta{align-self:flex-start; text-align:right}
    .price{font-weight:800; color:#f3f4f6; font-size:1.1rem}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; text-decoration:none; border:1px solid var(--line); background:#111827; color:#fff; font-weight:700}
    .btn.secondary{background:#0b1220; color:#e5e7eb}

    /* Tabs */
    .tabs{display:flex; gap:6px; padding:10px 22px; border-bottom:1px solid var(--line); background:#0f172a}
    .tab{padding:8px 12px; border:1px solid var(--line); background:#0b1220; border-radius:10px; cursor:pointer; font-weight:600; color:#cbd5e1}
    .tab[aria-selected="true"]{background:#111827; color:#fff; border-color:#111827}

    .grid{display:grid; grid-template-columns:1.2fr .8fr; gap:18px; padding:20px 22px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .section{border:1px solid var(--line); border-radius:14px; padding:16px; background:#0b1220}
    .section h3{margin:0 0 10px; color:#f8fafc}
    .list{margin:0; padding-left:1.1rem}
    .list li{margin:.25rem 0}

    .steps .row{display:grid; grid-template-columns:36px 1fr; gap:10px; margin:.6rem 0}
    .steps .num{width:36px; height:36px; border-radius:10px; border:1px solid var(--line); display:flex; align-items:center; justify-content:center; background:#0f172a}
    .note{color:var(--muted); font-size:.92rem}

    .nutri{width:100%; border-collapse:collapse; font-size:.92rem}
    .nutri th,.nutri td{border:1px solid var(--line); padding:6px 8px}
    .nutri th{background:#0f172a; text-align:left}

    .foot{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 22px; border-top:1px solid var(--line); background:#0f172a}
    .sig{font-size:.9rem; color:#94a3b8}

    @media print{ body{background:#fff} .wrap{margin:0; max-width:none; padding:0} .btn{display:none} .foot{border:0} .tabs{display:none} }
  </style>
</head>
<body>
  <div class="wrap">
    <article class="card" id="card">
      <header class="head">
        <div class="brand">
          <div class="logo" aria-hidden="true">‚òÖ</div>
          <h1 class="title" id="r-title">Carte Recette <small id="r-subtitle">‚Äî</small></h1>
        </div>
        <div class="badges">
          <span class="badge" id="b-sign">‚Äî</span>
          <span class="badge" id="b-meal">‚Äî</span>
          <span class="badge" id="b-state">‚Äî</span>
          <span class="badge" id="b-lang">FR</span>
          <span class="badge" id="b-base" hidden>‚Äî</span>
        </div>
      </header>

      <section class="hero">
        <div class="thumb" id="r-thumb" role="img" aria-label="Image du plat">üçΩÔ∏è</div>
        <div>
          <div class="meta" style="margin-bottom:10px">
            <div class="chip" id="c-servings">‚Äî</div>
            <div class="chip" id="c-diff">‚Äî</div>
            <div class="chip" id="c-method">‚Äî</div>
            <div class="chip" id="c-time">‚Äî</div>
            <div class="chip" id="c-cuisine">‚Äî</div>
            <div class="chip" id="c-course">‚Äî</div>
          </div>
          <p class="note" id="r-intro">‚Äî</p>
        </div>
        <div class="cta">
          <div class="price" id="r-price">‚Äî</div>
          <a class="btn" id="btn-buy" href="#" target="_blank" rel="noopener">üõí <span data-i18n="buy">Acheter</span></a>
          <div style="margin-top:8px"><a class="btn secondary" id="btn-print" href="#">üñ®Ô∏è <span data-i18n="print">Imprimer / PDF</span></a></div>
        </div>
      </section>

      <nav class="tabs" role="tablist" aria-label="Tabs">
        <button class="tab" id="tab-preview" role="tab" aria-selected="true" aria-controls="panel-preview">üëÄ <span data-i18n="tab_preview">Aper√ßu gratuit</span></button>
        <button class="tab" id="tab-full" role="tab" aria-selected="false" aria-controls="panel-full">ü™™ <span data-i18n="tab_full">Carte compl√®te</span></button>
      </nav>

      <section id="panel-preview" role="tabpanel" aria-labelledby="tab-preview" class="grid">
        <div>
          <div class="section">
            <h3 data-i18n="ingredients">Ingr√©dients</h3>
            <ul class="list" id="p-ingredients"></ul>
            <p class="note" id="p-ingredients-more" style="margin-top:8px"></p>
          </div>
          <div class="section steps" style="margin-top:12px">
            <h3 data-i18n="steps">√âtapes</h3>
            <div id="p-steps"></div>
            <p class="note" id="p-steps-more" style="margin-top:8px"></p>
          </div>
        </div>
        <aside>
          <div class="section">
            <h3 data-i18n="nutri">Valeurs nutritionnelles (‚âà/portion)</h3>
            <table class="nutri" id="p-nutri"></table>
          </div>
          <div class="section" style="margin-top:12px">
            <h3 data-i18n="allergens">Allerg√®nes</h3>
            <p class="note" id="p-allergens">‚Äî</p>
          </div>
        </aside>
      </section>

      <section id="panel-full" role="tabpanel" aria-labelledby="tab-full" class="grid" hidden>
        <div>
          <div class="section">
            <h3 data-i18n="ingredients">Ingr√©dients</h3>
            <ul class="list" id="r-ingredients"></ul>
          </div>
          <div class="section" style="margin-top:12px">
            <h3 data-i18n="equipment">Ustensiles</h3>
            <ul class="list" id="r-equipment"></ul>
          </div>
          <div class="section steps" style="margin-top:12px">
            <h3 data-i18n="steps">√âtapes</h3>
            <div id="r-steps"></div>
          </div>
        </div>
        <aside>
          <div class="section">
            <h3 data-i18n="nutri">Valeurs nutritionnelles (‚âà/portion)</h3>
            <table class="nutri" id="r-nutri"></table>
          </div>
          <div class="section" style="margin-top:12px">
            <h3 data-i18n="allergens_subs">Allerg√®nes & Substitutions</h3>
            <p class="note" id="r-allergens">‚Äî</p>
            <p class="note" id="r-subs" style="margin-top:6px">‚Äî</p>
          </div>
          <div class="section" style="margin-top:12px">
            <h3 data-i18n="storage">Conservation & R√©chauffage</h3>
            <p class="note" id="r-storage">‚Äî</p>
          </div>
        </aside>
      </section>

      <footer class="foot">
        <div class="sig">¬© AstroFood Premium Gold ‚Äî eatbythestars.com</div>
        <div><a class="btn secondary" id="btn-copy-url" href="#">üìã <span data-i18n="copy_url">Copier l‚ÄôURL</span></a></div>
      </footer>
    </article>
  </div>

  <script>
  (function(){
    'use strict';
    // I18N
    const I18N = {
      fr:{ buy:'Acheter', print:'Imprimer / PDF', tab_preview:'Aper√ßu gratuit', tab_full:'Carte compl√®te', ingredients:'Ingr√©dients', equipment:'Ustensiles', steps:'√âtapes', nutri:'Valeurs nutritionnelles (‚âà/portion)', allergens:'Allerg√®nes', allergens_subs:'Allerg√®nes & Substitutions', storage:'Conservation & R√©chauffage', copy_url:"Copier l‚ÄôURL", more_items:(n)=>`+${n} √©l√©ments suppl√©mentaires‚Ä¶`, more_steps:(n)=>`+${n} √©tapes suppl√©mentaires‚Ä¶`, meal:{breakfast:'Petit d√©jeuner', lunch:'D√©jeuner', dinner:'D√Æner'} },
      en:{ buy:'Buy', print:'Print / PDF', tab_preview:'Free preview', tab_full:'Full card', ingredients:'Ingredients', equipment:'Equipment', steps:'Steps', nutri:'Nutrition (‚âà/serv.)', allergens:'Allergens', allergens_subs:'Allergens & Substitutions', storage:'Storage & Reheat', copy_url:'Copy URL', more_items:(n)=>`+${n} more items‚Ä¶`, more_steps:(n)=>`+${n} more steps‚Ä¶`, meal:{breakfast:'Breakfast', lunch:'Lunch', dinner:'Dinner'} },
      ar:{ buy:'ÿ¥ÿ±ÿßÿ°', print:'ÿ∑ÿ®ÿßÿπÿ© / PDF', tab_preview:'ŸÖÿπÿßŸäŸÜÿ© ŸÖÿ¨ÿßŸÜŸäÿ©', tab_full:'ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ©', ingredients:'ÿßŸÑŸÖŸÉŸàŸëŸÜÿßÿ™', equipment:'ÿßŸÑÿ£ÿØŸàÿßÿ™', steps:'ÿßŸÑÿÆÿ∑Ÿàÿßÿ™', nutri:'ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿ∫ÿ∞ÿßÿ¶Ÿäÿ© (‚âà/ÿ≠ÿµŸëÿ©)', allergens:'ÿßŸÑŸÖÿ≥ÿ®Ÿëÿ®ÿßÿ™', allergens_subs:'ÿßŸÑŸÖÿ≥ÿ®Ÿëÿ®ÿßÿ™ ŸàÿßŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑÿßÿ™', storage:'ÿßŸÑÿ≠ŸÅÿ∏ ŸàÿßŸÑÿ™ÿ≥ÿÆŸäŸÜ', copy_url:'ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑', more_items:(n)=>`+${n} ÿπŸÜÿßÿµÿ± ÿ•ÿ∂ÿßŸÅŸäÿ©‚Ä¶`, more_steps:(n)=>`+${n} ÿÆÿ∑Ÿàÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©‚Ä¶`, meal:{breakfast:'ŸÅÿ∑Ÿàÿ±', lunch:'ÿ∫ÿØÿßÿ°', dinner:'ÿπÿ¥ÿßÿ°'} }
    };

    // Params
    const qs = new URLSearchParams(location.search);
    const lang = (qs.get('lang') || 'fr').toLowerCase();
    const sign = (qs.get('sign') || 'aries').toLowerCase();
    const state = (qs.get('state') || 'detox').toLowerCase();
    const meal = (qs.get('meal') || 'breakfast').toLowerCase();
    const base = (qs.get('base') || '').toLowerCase(); // produit africain choisi
    const tabParam = (qs.get('tab') || 'preview').toLowerCase();

    document.documentElement.lang = lang; document.documentElement.dir = (lang==='ar')?'rtl':'ltr';

    // Helpers
    const $ = (id)=>document.getElementById(id);
    const setText = (id, value)=>{ const el=$(id); if(!el) return; el.textContent = value??'‚Äî'; };
    function fillList(rootId, arr, limit){
      const root = $(rootId); if (!root) return; root.innerHTML = '';
      const total = (arr||[]).length; const n = (typeof limit==='number')? Math.min(limit,total): total;
      for(let i=0;i<n;i++){
        const it = arr[i] || {}; const li = document.createElement('li');
        const qty = (it.qty!==undefined)? String(it.qty):''; const unit = it.unit? (' '+it.unit):'';
        const name = it.item || ''; const notes = it.notes? (' ‚Äî '+it.notes):'';
        const left = (qty+unit).trim(); li.textContent = (left? left+' ‚Ä¢ ' : '') + name + notes; root.appendChild(li);
      }
      return (total - n) > 0 ? (total - n) : 0;
    }
    function addSteps(rootId, steps, limit){
      const root = $(rootId); if (!root) return; root.innerHTML='';
      const total = (steps||[]).length; const n = (typeof limit==='number')? Math.min(limit,total): total;
      for(let i=0;i<n;i++){
        const s = steps[i] || {}; const row = document.createElement('div'); row.className='row';
        const num = document.createElement('div'); num.className='num'; num.textContent = String(s.n || (i+1));
        const body = document.createElement('div'); const text = document.createElement('div'); text.textContent = s.text || '';
        body.appendChild(text);
        if (s.timer_sec){ const t=document.createElement('div'); t.className='note'; t.textContent = '‚è≤Ô∏è ' + Math.round(s.timer_sec/60) + ' min'; body.appendChild(t); }
        if (s.heat){ const h=document.createElement('div'); h.className='note'; h.textContent = 'üî• ' + s.heat; body.appendChild(h); }
        row.appendChild(num); row.appendChild(body); root.appendChild(row);
      }
      return (total - n) > 0 ? (total - n) : 0;
    }
    function renderNutrition(tblId, n){
      const tbl = $(tblId); tbl.innerHTML = '';
      const rows = [ ['√ânergie', n?.kcal ? n.kcal + ' kcal' : '‚Äî'], ['Prot√©ines', n?.protein_g ? n.protein_g + ' g' : '‚Äî'], ['Glucides', n?.carb_g ? n.carb_g + ' g' : '‚Äî'], ['Lipides', n?.fat_g ? n.fat_g + ' g' : '‚Äî'] ];
      if (n?.fiber_g) rows.push(['Fibres', n.fiber_g + ' g']); if (n?.sugar_g) rows.push(['Sucres', n.sugar_g + ' g']);
      rows.forEach(([k,v])=>{ const tr=document.createElement('tr'); const th=document.createElement('th'); th.textContent=k; const td=document.createElement('td'); td.textContent=v; tr.appendChild(th); tr.appendChild(td); tbl.appendChild(tr); });
    }
    function priceCFA(n){ return (typeof n==='number' && isFinite(n)) ? new Intl.NumberFormat('fr-FR').format(n) + ' CFA / recette' : '‚Äî'; }

    // Header badges (incl. african base)
    const SIGN_LABEL = { fr:{aries:'B√©lier',taurus:'Taureau',gemini:'G√©meaux',cancer:'Cancer',leo:'Lion',virgo:'Vierge',libra:'Balance',scorpio:'Scorpion',sagittarius:'Sagittaire',capricorn:'Capricorne',aquarius:'Verseau',pisces:'Poissons'}, en:{aries:'Aries',taurus:'Taurus',gemini:'Gemini',cancer:'Cancer',leo:'Leo',virgo:'Virgo',libra:'Libra',scorpio:'Scorpio',sagittarius:'Sagittarius',capricorn:'Capricorn',aquarius:'Aquarius',pisces:'Pisces'}, ar:{aries:'ÿßŸÑÿ≠ŸÖŸÑ',taurus:'ÿßŸÑÿ´Ÿàÿ±',gemini:'ÿßŸÑÿ¨Ÿàÿ≤ÿßÿ°',cancer:'ÿßŸÑÿ≥ÿ±ÿ∑ÿßŸÜ',leo:'ÿßŸÑÿ£ÿ≥ÿØ',virgo:'ÿßŸÑÿπÿ∞ÿ±ÿßÿ°',libra:'ÿßŸÑŸÖŸäÿ≤ÿßŸÜ',scorpio:'ÿßŸÑÿπŸÇÿ±ÿ®',sagittarius:'ÿßŸÑŸÇŸàÿ≥',capricorn:'ÿßŸÑÿ¨ÿØŸä',aquarius:'ÿßŸÑÿØŸÑŸà',pisces:'ÿßŸÑÿ≠Ÿàÿ™'} };
    function setBadges(){
      const t = I18N[lang]||I18N.fr; const lbl = (SIGN_LABEL[lang]||SIGN_LABEL.fr)[sign] || sign;
      setText('b-sign', lbl); setText('b-state', state); setText('b-meal', t.meal?.[meal] || meal); setText('b-lang', lang.toUpperCase());
      if (base){ const bEl=$('b-base'); bEl.hidden=false; bEl.textContent = 'Base: '+base; }
    }

    // API
    const API_URL = window.ASTROFOOD_API_URL || '/api/astrofood';
    async function fetchRecipe(){
      const payload = base
        ? { lang, sign, state, meal, base, mode:'recipe_from_product' }
        : { lang, sign, state, meal, mode: 'recipe' };
      const r = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if (!r.ok) throw new Error('HTTP '+r.status);
      const json = await r.json();
      return json.recipe || json; // server-side translation preferred
    }

    // Tabs
    function selectTab(which){
      const isPreview = (which === 'preview');
      document.getElementById('tab-preview').setAttribute('aria-selected', String(isPreview));
      document.getElementById('tab-full').setAttribute('aria-selected', String(!isPreview));
      document.getElementById('panel-preview').hidden = !isPreview;
      document.getElementById('panel-full').hidden = isPreview;
    }

    // Load + Render
    async function load(){
      // i18n labels
      const t = I18N[lang]||I18N.fr; document.querySelectorAll('[data-i18n]')?.forEach(el => { const key = el.getAttribute('data-i18n'); const v = t[key]; if (typeof v === 'string') el.textContent = v; });
      setBadges();
      document.getElementById('btn-buy').href = (window.LEMONSQUEEZY_URL || 'https://astrofood.lemonsqueezy.com/buy/PRODUCT_ID');
      try{
        const d = await fetchRecipe();
        const emoji = d.image_emoji || d.emoji || 'üçΩÔ∏è'; document.getElementById('r-thumb').textContent = emoji;
        setText('r-title', d.title || 'Recette'); setText('r-subtitle', d.subtitle || '');
        setText('c-servings', d.servings? d.servings+' portions':'‚Äî'); setText('c-diff', d.difficulty||'‚Äî'); setText('c-method', d.method||'‚Äî');
        const total = d.time?.total || ((d.time?.prep||0)+(d.time?.cook||0)||null); setText('c-time', total? ('Total: '+total+' min'):'‚Äî');
        setText('c-cuisine', d.cuisine||'‚Äî'); setText('c-course', d.course|| (I18N[lang].meal?.[meal]||'‚Äî') );
        document.getElementById('r-price').textContent = priceCFA(d.price_cfa);
        document.getElementById('r-intro').textContent = d.intro || d.description || '';

        // PREVIEW (free)
        const moreIng = fillList('p-ingredients', d.ingredients, 5);
        document.getElementById('p-ingredients-more').textContent = moreIng>0 ? (I18N[lang].more_items(moreIng)) : '';
        const moreSteps = addSteps('p-steps', d.steps, 2);
        document.getElementById('p-steps-more').textContent = moreSteps>0 ? (I18N[lang].more_steps(moreSteps)) : '';
        renderNutrition('p-nutri', d.nutrition||{});
        setText('p-allergens', (d.allergens&&d.allergens.length)? d.allergens.join(', '):'‚Äî');

        // FULL (paid)
        fillList('r-ingredients', d.ingredients);
        fillList('r-equipment', d.equipment, undefined);
        addSteps('r-steps', d.steps);
        renderNutrition('r-nutri', d.nutrition||{});
        setText('r-allergens', (d.allergens&&d.allergens.length)? d.allergens.join(', '):'‚Äî');
        setText('r-subs', (d.substitutions&&d.substitutions.length)? d.substitutions.join(' ‚Ä¢ '):'‚Äî');
        if (d.storage){
          const arr=[]; if (d.storage.fridge_days) arr.push('Frigo: '+d.storage.fridge_days+' j.'); if (d.storage.freezer_days) arr.push('Cong√©lateur: '+d.storage.freezer_days+' j.'); if (d.storage.reheat) arr.push('R√©chauffage: '+d.storage.reheat);
          setText('r-storage', arr.join(' ‚Ä¢ ') || '‚Äî');
        } else { setText('r-storage','‚Äî'); }

        // Select tab
        selectTab(tabParam==='full' ? 'full' : 'preview');
      } catch(e){
        console.error(e);
        document.getElementById('p-steps').innerHTML = '<p class="note">‚ùå Impossible de charger la recette.</p>';
      }
    }

    // Events
    document.getElementById('btn-copy-url').addEventListener('click', async (e)=>{ e.preventDefault(); try{ await navigator.clipboard.writeText(location.href); alert('URL copi√©e ‚úÖ'); }catch(_){ alert('Impossible de copier'); }});
    document.getElementById('btn-print').addEventListener('click', (e)=>{ e.preventDefault(); window.print(); });
    document.getElementById('tab-preview').addEventListener('click', ()=> selectTab('preview'));
    document.getElementById('tab-full').addEventListener('click', ()=> selectTab('full'));

    // Init
    load();
  })();
  </script>
</body>
</html>
