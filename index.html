<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AstroFood Premium Gold ‚Äî Index (Dark Astral v16.5)</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --bg: radial-gradient(1200px 600px at 20% -10%, #0f172a 0%, #020617 60%);
      --surface: rgba(15,23,42,.6);
      --surface-2: rgba(2,6,23,.65);
      --border: #1f2937;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --gold:#FBBF24;
      --accent:#38bdf8;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    *,*:before,*:after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans, sans-serif; display:flex; flex-direction:column}

    /* Topbar */
    .topbar{display:flex; align-items:center; justify-content:space-between; padding:.9rem 1.25rem; border-bottom:1px solid var(--border); background:linear-gradient(to bottom, rgba(2,6,23,.9), rgba(2,6,23,.6)); position:sticky; top:0; z-index:30; backdrop-filter: blur(6px)}
    .brand{display:flex; align-items:center; gap:.75rem}
    .brand .dot{width:10px; height:10px; border-radius:50%; background:var(--gold); box-shadow:0 0 0 6px rgba(251,191,36,.15)}
    .brand h1{font-size:1.05rem; margin:0; letter-spacing:.4px; color:var(--gold)}
    .actions{display:flex; align-items:center; gap:.5rem}
    .badge{font-size:.75rem; opacity:.75; border:1px solid var(--border); padding:.25rem .5rem; border-radius:999px}

    /* Layout */
    .layout{display:grid; grid-template-columns: 340px 1fr; gap:1.25rem; padding:1.25rem; width:100%; max-width:1280px; margin:0 auto; flex:1}
    @media (max-width: 960px){ .layout{grid-template-columns:1fr} }
    .panel{background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}

    /* Sidebar */
    .sidebar{padding:1rem}
    .sidebar h2{font-size:1rem; margin:.25rem 0 1rem; color:var(--muted)}
    .field{margin-bottom:1rem}
    .field label{display:block; margin-bottom:.4rem; font-size:.9rem; color:var(--muted)}
    select, .btn{width:100%; padding:.7rem .85rem; border-radius:12px; border:1px solid var(--border); background:var(--surface-2); color:var(--text); outline:none}
    select:focus{border-color:var(--accent); box-shadow:0 0 0 4px rgba(56,189,248,.15)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:.75rem}
    .btn.primary{background:var(--gold); color:#111827; border:none; font-weight:700; cursor:pointer}
    .btn.primary:active{transform:translateY(1px)}
    .hint{font-size:.82rem; color:var(--muted); margin-top:.35rem}

    /* Content */
    .content{display:flex; flex-direction:column}
    .hero{padding:1rem 1.25rem; border-bottom:1px solid var(--border)}
    .hero h3{margin:.2rem 0 .35rem; color:var(--gold)}
    .hero p{margin:0; color:var(--muted)}

    .work{display:grid; grid-template-columns: 1fr 460px; gap:1rem; padding:1rem}
    @media (max-width: 1220px){ .work{grid-template-columns:1fr} }

    .output{min-height:280px; padding:1rem; border:1px dashed var(--border); border-radius:12px; background:rgba(2,6,23,.45)}
    .output h4{margin:.25rem 0 .5rem}
    .toolbar{display:flex; gap:.5rem; margin-bottom:.6rem}
    .tool{padding:.5rem .7rem; border:1px solid var(--border); border-radius:10px; background:var(--surface-2); color:var(--text); cursor:pointer}
    .tool:active{transform:translateY(1px)}

    /* Preview right panel with tabs */
    .preview{padding:0; overflow:hidden}
    .preview-head{display:flex; align-items:center; justify-content:space-between; padding:.75rem 1rem; border-bottom:1px solid var(--border)}
    .tabs{display:flex; gap:.4rem}
    .tab{padding:.4rem .6rem; border:1px solid var(--border); border-radius:10px; background:var(--surface-2); cursor:pointer}
    .tab[aria-selected="true"]{background:#0b1220}
    .pane{display:none}
    .pane.active{display:block}
    .pane iframe{width:100%; height:420px; border:0; display:block; background:#0b1220}

    /* Coach */
    .coach{padding:1rem}
    .coach h4{margin:.2rem 0 .6rem}
    .pill{display:inline-flex; align-items:center; gap:.35rem; border:1px solid var(--border); background:var(--surface-2); padding:.35rem .6rem; border-radius:10px; margin:.15rem .25rem .15rem 0}
    .list{margin:.4rem 0 .2rem; padding-left:1.1rem}
    .step{border:1px dashed var(--border); border-radius:10px; padding:.6rem .7rem; margin:.5rem 0}
    .step .row{display:flex; align-items:center; justify-content:space-between; gap:.5rem}
    .timer{font-family:ui-monospace,Menlo,Consolas,monospace; padding:.15rem .4rem; border:1px solid var(--border); border-radius:8px}
    .tiny{font-size:.82rem; color:var(--muted)}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand"><span class="dot"></span><h1>AstroFood Premium Gold</h1></div>
    <div class="actions">
      <span class="badge">Dark Astral</span>
      <span class="badge">v16.5</span>
    </div>
  </header>

  <main class="layout">
    <!-- Sidebar Controls -->
    <aside class="panel sidebar" id="controls">
      <h2 id="lbl-controls">Contr√¥les</h2>

      <div class="field">
        <label for="lang" id="lbl-lang">Langue</label>
        <select id="lang">
          <option value="fr">Fran√ßais</option>
          <option value="en">English</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        </select>
        <div class="hint" id="hint-lang">Astuce¬†: <span class="kbd">L</span> pour basculer rapidement.</div>
      </div>

      <div class="field">
        <label for="sign" id="lbl-sign">Votre signe</label>
        <select id="sign">
          <option value="aries">B√©lier</option><option value="taurus">Taureau</option>
          <option value="gemini">G√©meaux</option><option value="cancer">Cancer</option>
          <option value="leo">Lion</option><option value="virgo">Vierge</option>
          <option value="libra">Balance</option><option value="scorpio">Scorpion</option>
          <option value="sagittarius">Sagittaire</option><option value="capricorn">Capricorne</option>
          <option value="aquarius">Verseau</option><option value="pisces">Poissons</option>
        </select>
      </div>

      <div class="row">
        <div class="field">
          <label for="state" id="lbl-state">Objectif / √âtat</label>
          <select id="state">
            <option value="detox">D√©tox</option>
            <option value="energy_boost">Booster √©nergie</option>
            <option value="stress_relief">Anti-stress</option>
            <option value="immunity">Immunit√©</option>
            <option value="digestion">Digestion</option>
            <option value="metabolic_balance">Balance m√©tabolique</option>
          </select>
        </div>
        <div class="field">
          <label for="plan" id="lbl-plan">Plan de repas</label>
          <select id="plan">
            <option value="single">Recette unique</option>
            <option value="daily3">3 repas / jour</option>
          </select>
        </div>
      </div>

      <div class="field">
        <button class="btn primary" id="btn-recipe" type="button">üç≥ <span id="btn-generate-label">G√©n√©rer</span></button>
      </div>

      <div class="field">
        <a class="btn" id="open-digital-card" href="/card.html" target="_blank" rel="noopener">üìá <span id="btn-card-label">Ouvrir la carte digitale</span></a>
        <div class="hint" id="hint-card">La carte s'ouvre dans un nouvel onglet.</div>
      </div>
    </aside>

    <!-- Main Content -->
    <section class="panel content">
      <div class="hero">
        <h3 id="hero-title">Assistant Chef‚ÄëAI</h3>
        <p id="hero-desc">G√©n√©rez des recettes et plans 3¬†repas adapt√©s √† votre signe et votre objectif.</p>
      </div>

      <div class="work">
        <div>
          <div class="toolbar">
            <button class="tool" id="copy-html">Copier HTML</button>
            <button class="tool" id="clear-output">Effacer</button>
            <button class="tool" id="ping-api">Tester l‚ÄôAPI</button>
          </div>
          <div id="ai-output" class="output">Pr√™t.</div>
        </div>

        <div class="panel preview">
          <div class="preview-head">
            <div class="tabs" role="tablist" aria-label="Preview tabs">
              <button class="tab" id="tab-card" role="tab" aria-selected="true" aria-controls="pane-card">ü™™ Carte</button>
              <button class="tab" id="tab-coach" role="tab" aria-selected="false" aria-controls="pane-coach">üë®‚Äçüç≥ Coach‚ÄëAI</button>
            </div>
            <div class="hint" id="preview-hint">Raccourcis¬†: <span class="kbd">Ctrl</span>+<span class="kbd">Entr√©e</span> pour g√©n√©rer</div>
          </div>
          <div id="pane-card" class="pane active"><iframe id="preview" title="Aper√ßu carte" srcdoc="<html><body style='margin:0;background:#0b1220;color:#94a3b8;font-family:system-ui;display:flex;align-items:center;justify-content:center;height:100%'>Cliquez ‚ÄòOuvrir la carte digitale‚Äô</body></html>"></iframe></div>
          <div id="pane-coach" class="pane">
            <div class="coach" id="coach">
              <h4>Coach‚ÄëAI</h4>
              <div class="row" style="margin-bottom:.6rem">
                <button class="tool" id="btn-advice">üß† <span data-i18n-coach="advice_btn">Conseil nutritionnel</span></button>
                <div style="display:flex; gap:.4rem; width:100%">
                  <select id="african-product" style="flex:1" title="Produit africain">
                    <option value="">‚Äî Produit africain (au choix) ‚Äî</option>
                    <option value="mil">Mil</option>
                    <option value="fonio">Fonio</option>
                    <option value="manioc">Manioc</option>
                    <option value="patate_douce">Patate douce</option>
                    <option value="ni√©b√©">Ni√©b√© (haricot)</option>
                    <option value="gombo">Gombo</option>
                    <option value="bissap">Bissap</option>
                    <option value="bouye">Bouye (pain de singe)</option>
                    <option value="arachide">Arachide</option>
                    <option value="thiof">Thiof (m√©rou)</option>
                  </select>
                  <button class="tool" id="btn-gen-from-product">üë©‚Äçüç≥ <span data-i18n-coach="gen_from">G√©n√©rer recette</span></button>
                </div>
              </div>
              <div id="coach-output"></div>
              <p class="tiny">G√©n√®re une recette d‚Äôabord pour activer minuteries et liste de courses. Les conseils et la g√©n√©ration par produit fonctionnent sans recette pr√©alable.</p>
            </div>
          </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
  (() => {
    if (window.__ASTROFOOD_INIT__) return; window.__ASTROFOOD_INIT__ = true;
    const TEST_MODE = false; let LAST_ERROR=null; let LAST_RECIPE=null; let TIMERS={};

    const $ = s => document.querySelector(s);
    const lang = $('#lang'); const sign = $('#sign'); const state = $('#state'); const plan = $('#plan');
    const out = $('#ai-output'); const btn = $('#btn-recipe'); const openCard = $('#open-digital-card');

    // i18n labels
    const I18N = {
      fr: {controls:'Contr√¥les', lang:'Langue', hintLang:'Astuce¬†: L pour basculer rapidement.', sign:'Votre signe', state:'Objectif / √âtat', plan:'Plan de repas', generate:'G√©n√©rer', card:'Ouvrir la carte digitale', hintCard:"La carte s'ouvre dans un nouvel onglet.", heroTitle:'Assistant Chef‚ÄëAI', heroDesc:'G√©n√©rez des recettes et plans 3 repas adapt√©s √† votre signe et votre objectif.', generating:'üç≥ G√©n√©ration‚Ä¶', error:'‚ùå Erreur de g√©n√©ration', previewHint:'Raccourcis¬†: Ctrl+Entr√©e pour g√©n√©rer', coachTitle:'Coach‚ÄëAI', shopping:'Liste de courses', subs:'Substitutions', steps:'√âtapes', start:'D√©marrer', stop:'Arr√™ter', timer:'Minuteur' },
      en: {controls:'Controls', lang:'Language', hintLang:'Tip: press L to switch quickly.', sign:'Your sign', state:'Goal / State', plan:'Meal plan', generate:'Generate', card:'Open digital card', hintCard:'The card opens in a new tab.', heroTitle:'Chef‚ÄëAI Assistant', heroDesc:'Generate recipes and 3‚Äëmeal plans tailored to your sign and goal.', generating:'üç≥ Generating‚Ä¶', error:'‚ùå Generation error', previewHint:'Shortcuts: Ctrl+Enter to generate', coachTitle:'AI Coach', shopping:'Shopping list', subs:'Substitutions', steps:'Steps', start:'Start', stop:'Stop', timer:'Timer' },
      ar: {controls:'ÿßŸÑÿ™ÿ≠ŸÉŸÖ', lang:'ÿßŸÑŸÑÿ∫ÿ©', hintLang:'ŸÜÿµŸäÿ≠ÿ©: ÿßÿ∂ÿ∫ÿ∑ L ŸÑŸÑÿ™ÿ®ÿØŸäŸÑ ÿ®ÿ≥ÿ±ÿπÿ©.', sign:'ÿ®ÿ±ÿ¨ŸÉ', state:'ÿßŸÑŸáÿØŸÅ / ÿßŸÑÿ≠ÿßŸÑÿ©', plan:'ÿÆÿ∑ÿ© ÿßŸÑŸàÿ¨ÿ®ÿßÿ™', generate:'ÿ•ŸÜÿ¥ÿßÿ°', card:'ŸÅÿ™ÿ≠ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ±ŸÇŸÖŸäÿ©', hintCard:'ÿ™ŸÅÿ™ÿ≠ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ŸÅŸä ÿπŸÑÿßŸÖÿ© ÿ™ÿ®ŸàŸäÿ® ÿ¨ÿØŸäÿØÿ©.', heroTitle:'ŸÖÿ≥ÿßÿπÿØ ÿßŸÑÿ¥ŸäŸÅ‚ÄëAI', heroDesc:'ÿ£ŸÜÿ¥ÿ¶ ŸàÿµŸÅÿßÿ™ ŸàÿÆÿ∑ÿ∑ Ÿ£ Ÿàÿ¨ÿ®ÿßÿ™ ÿ≠ÿ≥ÿ® ÿ®ÿ±ÿ¨ŸÉ ŸàŸáÿØŸÅŸÉ.', generating:'üç≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°‚Ä¶', error:'‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°', previewHint:'ÿßÿÆÿ™ÿµÿßÿ±: Ctrl+Enter ŸÑŸÑÿ•ŸÜÿ¥ÿßÿ°', coachTitle:'ŸÖÿØÿ±Ÿëÿ® ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä', shopping:'ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ™ÿ≥ŸàŸëŸÇ', subs:'ÿßŸÑÿ®ÿØÿßÿ¶ŸÑ', steps:'ÿßŸÑÿÆÿ∑Ÿàÿßÿ™', start:'ÿßÿ®ÿØÿ£', stop:'ÿ£ŸàŸÇŸÅ', timer:'ŸÖÿ§ŸÇŸëÿ™' }
    };

    function applyI18N(code){
      const t = I18N[code] || I18N.fr;
      $('#lbl-controls').textContent = t.controls; $('#lbl-lang').textContent = t.lang; $('#hint-lang').textContent = t.hintLang;
      $('#lbl-sign').textContent = t.sign; $('#lbl-state').textContent = t.state; $('#lbl-plan').textContent = t.plan;
      $('#btn-generate-label').textContent = t.generate; $('#btn-card-label').textContent = t.card; $('#hint-card').textContent = t.hintCard;
      $('#hero-title').textContent = t.heroTitle; $('#hero-desc').textContent = t.heroDesc; $('#preview-hint').textContent = t.previewHint;
      document.getElementById('tab-coach').textContent = (code==='ar'?'üë®‚Äçüç≥ '+I18N.ar.coachTitle: 'üë®‚Äçüç≥ '+t.coachTitle);
      document.documentElement.lang = code; document.documentElement.dir = (code==='ar')?'rtl':'ltr';
    }
    applyI18N(lang.value || 'fr'); lang.addEventListener('change', ()=> applyI18N(lang.value || 'fr'));

    const API_URL = window.ASTROFOOD_API_URL || '/api/astrofood'; let busy=false;

    async function generate(){
      if (busy) return; busy=true; const code=lang.value||'fr'; const t=I18N[code]||I18N.fr; out.textContent=t.generating;
      const payload={ lang:code, sign:sign.value, state:state.value, plan:plan.value, mode:(plan.value==='daily3')?'mealplan':'recipe' };
      try{
        if (TEST_MODE){ out.innerHTML='<h4>Recette</h4><p>Shake d√©tox citron‚Äëgingembre‚Äëmenthe üçãüå±</p>'; LAST_RECIPE={ title:'Recette d√©mo', ingredients:[{item:'Eau',qty:250,unit:'ml'}], steps:[{n:1,text:'M√©langer.'}]}; renderCoach(); return; }
        let r; try{ r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});}catch(netErr){ LAST_ERROR=netErr; throw new Error('NETWORK_ERROR: '+netErr.message); }
        if(!r.ok){ const txt=await r.text().catch(()=> ''); LAST_ERROR={status:r.status, body:txt}; throw new Error('HTTP_'+r.status+' '+txt.slice(0,120)); }
        let data; try{ data=await r.json(); }catch(parseErr){ LAST_ERROR={parse:'JSON'}; throw new Error('INVALID_JSON'); }
        if(payload.mode==='mealplan'){
          const b=data?.breakfast||'‚Äî', l=data?.lunch||'‚Äî', d=data?.dinner||'‚Äî';
          out.innerHTML=`<h4>Plan</h4><ul><li><strong>Breakfast / Petit‚Äëd√©j:</strong> ${b}</li><li><strong>Lunch / D√©jeuner:</strong> ${l}</li><li><strong>Dinner / D√Æner:</strong> ${d}</li></ul>`;
          LAST_RECIPE=null; renderCoach(true);
        } else {
          const rec=data?.recipe||data; LAST_RECIPE=rec;
          const title = rec?.title||'Recette'; const bodyText = rec?.intro||rec?.description||'';
          out.innerHTML=`<h4>${title}</h4><p>${bodyText}</p>`; renderCoach();
        }
      }catch(err){ console.error('[AstroFood] generate() error ‚Üí', err,'\nLAST_ERROR:',LAST_ERROR); const msg=(I18N[lang.value]?.error||I18N.fr.error); out.innerHTML=`${msg}<pre style="white-space:pre-wrap;margin-top:.5rem;opacity:.8;border:1px dashed var(--border);padding:.5rem;border-radius:8px">${(err?.message||String(err)).slice(0,400)}</pre>`; }
      finally{ busy=false; }
    }

    btn.addEventListener('click', generate);

    // Shortcuts
    document.addEventListener('keydown', (e)=>{ if (e.ctrlKey && e.key==='Enter') generate(); if (!e.ctrlKey && (e.key==='l'||e.key==='L')){ const values=['fr','en','ar']; const i=values.indexOf(lang.value); lang.value=values[(i+1)%values.length]; lang.dispatchEvent(new Event('change')); } });

    // Card link with params
    function cardURL(){ const params=new URLSearchParams({sign:sign.value,lang:lang.value,state:state.value,plan:plan.value}); const base=openCard.getAttribute('href')||'/card.html'; const url=new URL(base, window.location.origin); url.search=params.toString(); return url.toString(); }
    openCard.addEventListener('click', ()=>{ openCard.setAttribute('href', cardURL()); $('#tab-card').click(); $('#preview').src = cardURL(); });

    // Copy & Ping
    $('#copy-html').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(out.innerHTML.trim()); alert('HTML copi√© ‚úÖ'); }catch(err){ alert('Impossible de copier'); } });
    $('#clear-output').addEventListener('click', ()=>{ out.textContent='Pr√™t.'; });
    $('#ping-api').addEventListener('click', async ()=>{ try{ const r=await fetch(API_URL,{method:'GET'}); const ok=r.ok; const text=await r.text(); out.innerHTML=`<strong>Ping API:</strong> ${ok?'‚úÖ OK':'‚ùå'}<pre style="white-space:pre-wrap;margin-top:.5rem;opacity:.85;border:1px dashed var(--border);padding:.5rem;border-radius:8px">${text.slice(0,400)}</pre>`; }catch(e){ out.innerHTML=`<strong>Ping API:</strong> ‚ùå<pre style="white-space:pre-wrap;margin-top:.5rem;opacity:.85;border:1px dashed var(--border);padding:.5rem;border-radius:8px">${String(e).slice(0,400)}</pre>`; } });

    // Tabs logic
    function selectTab(which){ const card=(which==='card'); document.getElementById('tab-card').setAttribute('aria-selected', String(card)); document.getElementById('tab-coach').setAttribute('aria-selected', String(!card)); document.getElementById('pane-card').classList.toggle('active', card); document.getElementById('pane-coach').classList.toggle('active', !card); }
    $('#tab-card').addEventListener('click', ()=> selectTab('card')); $('#tab-coach').addEventListener('click', ()=> selectTab('coach'));

    // Coach‚ÄëAI renderer (client-side, no API change)
    function msToMinSec(ms){ const sec=Math.max(0, Math.floor(ms/1000)); const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return m+':'+s; }
    function startTimer(id, secs){ stopTimer(id); const el=document.querySelector(`[data-timer='${id}']`); if(!el) return; const end=Date.now()+secs*1000; TIMERS[id]=setInterval(()=>{ const left=end-Date.now(); if(left<=0){ clearInterval(TIMERS[id]); el.textContent='00:00'; el.dataset.done='1'; return; } el.textContent=msToMinSec(left); }, 250); }
    function stopTimer(id){ if(TIMERS[id]){ clearInterval(TIMERS[id]); delete TIMERS[id]; } }

    function renderCoach(isPlan=false){ const root=$('#coach'); const t=I18N[lang.value]||I18N.fr; root.innerHTML=''; const h=document.createElement('h4'); h.textContent=t.coachTitle; root.appendChild(h);
      if(isPlan){ const p=document.createElement('p'); p.className='tiny'; p.textContent='Le mode Coach‚ÄëAI est disponible pour les recettes uniques.'; root.appendChild(p); return; }
      const r=LAST_RECIPE; if(!r){ const p=document.createElement('p'); p.className='tiny'; p.textContent='G√©n√®re une recette pour activer le Coach‚ÄëAI.'; root.appendChild(p); return; }
      // Shopping list
      const box1=document.createElement('div'); box1.innerHTML=`<div class='pill'>üßæ ${t.shopping}</div>`; root.appendChild(box1);
      const ul=document.createElement('ul'); ul.className='list'; (r.ingredients||[]).slice(0,12).forEach(it=>{ const li=document.createElement('li'); const qty=(it.qty!==undefined? it.qty:''); const unit=it.unit?(' '+it.unit):''; const name=it.item||''; li.textContent=(qty||unit? (qty+unit+' ‚Ä¢ '):'')+name+(it.notes?(' ‚Äî '+it.notes):''); ul.appendChild(li); }); root.appendChild(ul);
      // Substitutions
      if (r.substitutions && r.substitutions.length){ const box2=document.createElement('div'); box2.innerHTML=`<div class='pill'>üîÅ ${t.subs}</div>`; root.appendChild(box2); const p=document.createElement('p'); p.className='tiny'; p.textContent=r.substitutions.join(' ‚Ä¢ '); root.appendChild(p); }
      // Step timers
      const box3=document.createElement('div'); box3.innerHTML=`<div class='pill'>‚è≤Ô∏è ${t.steps}</div>`; root.appendChild(box3);
      (r.steps||[]).forEach((s,i)=>{ const step=document.createElement('div'); step.className='step'; const id='step_'+(s.n||i+1); step.innerHTML=`<div class='row'><div>${(s.n||i+1)+'. '+(s.text||'')}</div><div><span class='timer' data-timer='${id}'>${s.timer_sec? msToMinSec(s.timer_sec*1000):'--:--'}</span> <button class='tool' data-start='${id}'>${t.start}</button> <button class='tool' data-stop='${id}'>${t.stop}</button></div></div>`; root.appendChild(step); });
      root.querySelectorAll('[data-start]').forEach(b=> b.addEventListener('click', ()=>{ const id=b.getAttribute('data-start'); const step=(r.steps||[]).find(x=>('step_'+(x.n||r.steps.indexOf(x)+1))===id); const secs=(step&&step.timer_sec)||0; if(secs>0) startTimer(id, secs); }));
      root.querySelectorAll('[data-stop]').forEach(b=> b.addEventListener('click', ()=> stopTimer(b.getAttribute('data-stop')) ));
    }
  })();
  // === Coach extras: labels, advice, and recipe-from-product ===
    (function(){
      const I = window.I18N || undefined; // may not be global; safe-guard below
      function t(key, fallback){ try{ return (I && (I[document.documentElement.lang]||I.fr||{}))[key] || fallback; }catch(_){ return fallback; } }
      // translate buttons if present
      function applyCoachI18N(){
        const el1 = document.querySelector('[data-i18n-coach="advice_btn"]'); if (el1) el1.textContent = t('advice_btn','Conseil nutritionnel');
        const el2 = document.querySelector('[data-i18n-coach="gen_from"]'); if (el2) el2.textContent = t('gen_from','G√©n√©rer recette');
      }
      applyCoachI18N();

      // helper post JSON (idempotent)
      if (!window.__postJSON__) {
        window.__postJSON__ = async (url, payload)=>{ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); };
      }
      const API_URL = window.ASTROFOOD_API_URL || '/api/astrofood';

      const adviceBtn = document.getElementById('btn-advice');
      const genBtn = document.getElementById('btn-gen-from-product');
      const prodSel = document.getElementById('african-product');
      const outBox = document.getElementById('coach-output');

      if (adviceBtn) adviceBtn.addEventListener('click', async ()=>{
        if (!outBox) return;
        outBox.innerHTML = '<div class="pill">üß† '+ (t('advice_btn','Conseil nutritionnel')) +'</div>';
        try{
          const lang = document.getElementById('lang').value; const sign = document.getElementById('sign').value; const state = document.getElementById('state').value;
          const data = await window.__postJSON__(API_URL, { mode:'advice', lang, sign, state });
          const adv = data?.advice || data || {};
          const wrap=document.createElement('div'); wrap.className='step';
          const dTitle=document.createElement('div'); dTitle.innerHTML='<strong>'+t('advice_do','√Ä faire')+':</strong>';
          const dList=document.createElement('ul'); dList.className='list'; (adv.do||[]).forEach(x=>{ const li=document.createElement('li'); li.textContent=String(x); dList.appendChild(li); });
          const aTitle=document.createElement('div'); aTitle.style.marginTop='.5rem'; aTitle.innerHTML='<strong>'+t('advice_avoid','√Ä √©viter')+':</strong>';
          const aList=document.createElement('ul'); aList.className='list'; (adv.avoid||[]).forEach(x=>{ const li=document.createElement('li'); li.textContent=String(x); aList.appendChild(li); });
          wrap.appendChild(dTitle); wrap.appendChild(dList); wrap.appendChild(aTitle); wrap.appendChild(aList); outBox.appendChild(wrap);
        }catch(e){ outBox.innerHTML += '<p class="tiny">‚ùå '+ (e.message||e) +'</p>'; }
      });

      if (genBtn) genBtn.addEventListener('click', async ()=>{
        if (!prodSel || !prodSel.value){ alert('Choisis un produit africain.'); return; }
        try{
          const lang = document.getElementById('lang').value; const sign = document.getElementById('sign').value; const state = document.getElementById('state').value;
          const data = await window.__postJSON__(API_URL, { mode:'recipe_from_product', lang, sign, state, base: prodSel.value });
          const rec = data?.recipe || data; window.LAST_RECIPE = rec; // expose for existing coach renderers
          const out = document.getElementById('ai-output'); if (out) { out.innerHTML = `<h4>${rec.title||'Recette'}</h4><p>${rec.intro||rec.description||''}</p>`; }
          const tabCoach = document.getElementById('tab-coach'); if (tabCoach) tabCoach.click();
          if (typeof window.renderCoach==='function') try{ window.renderCoach(false); }catch(_){ /*optional*/ }
        }catch(e){ if(outBox) outBox.innerHTML += '<p class="tiny">‚ùå '+ (e.message||e) +'</p>'; }
      });
    })();
  </script>
</body>
</html>
