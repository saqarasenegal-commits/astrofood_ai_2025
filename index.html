<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AstroFood Premium Gold ‚Äî Desktop v16 (Fixed)</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --bg: radial-gradient(1200px 600px at 20% -10%, #0f172a 0%, #020617 60%);
      --surface: rgba(15,23,42,.6);
      --surface-2: rgba(2,6,23,.65);
      --border: #1f2937;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --gold:#FBBF24;
      --accent:#38bdf8;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    *,*:before,*:after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; display:flex; flex-direction:column}
    /* --- Topbar --- */
    .topbar{display:flex; align-items:center; justify-content:space-between; padding:.9rem 1.25rem; border-bottom:1px solid var(--border); background:linear-gradient(to bottom, rgba(2,6,23,.9), rgba(2,6,23,.6)); position:sticky; top:0; z-index:30; backdrop-filter: blur(6px)}
    .brand{display:flex; align-items:center; gap:.75rem}
    .brand .dot{width:10px; height:10px; border-radius:50%; background:var(--gold); box-shadow:0 0 0 6px rgba(251,191,36,.15)}
    .brand h1{font-size:1.05rem; margin:0; letter-spacing:.4px; color:var(--gold)}
    .actions{display:flex; align-items:center; gap:.5rem}
    .badge{font-size:.75rem; opacity:.75; border:1px solid var(--border); padding:.25rem .5rem; border-radius:999px}

    /* --- Layout --- */
    .layout{display:grid; grid-template-columns: 340px 1fr; gap:1.25rem; padding:1.25rem; width:100%; max-width:1280px; margin:0 auto; flex:1}
    @media (max-width: 960px){ .layout{grid-template-columns:1fr} }
    .panel{background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}

    /* --- Sidebar --- */
    .sidebar{padding:1rem}
    .sidebar h2{font-size:1rem; margin:.25rem 0 1rem; color:var(--muted)}
    .field{margin-bottom:1rem}
    .field label{display:block; margin-bottom:.4rem; font-size:.9rem; color:var(--muted)}
    select, .btn{width:100%; padding:.7rem .85rem; border-radius:12px; border:1px solid var(--border); background:var(--surface-2); color:var(--text); outline:none}
    select:focus{border-color:var(--accent); box-shadow:0 0 0 4px rgba(56,189,248,.15)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:.75rem}
    .btn.primary{background:var(--gold); color:#111827; border:none; font-weight:700; cursor:pointer}
    .btn.primary:active{transform:translateY(1px)}
    .hint{font-size:.82rem; color:var(--muted); margin-top:.35rem}

    /* --- Content --- */
    .content{display:flex; flex-direction:column}
    .hero{padding:1rem 1.25rem; border-bottom:1px solid var(--border)}
    .hero h3{margin:.2rem 0 .35rem; color:var(--gold)}
    .hero p{margin:0; color:var(--muted)}

    .work{display:grid; grid-template-columns: 1fr 420px; gap:1rem; padding:1rem}
    @media (max-width: 1200px){ .work{grid-template-columns:1fr} }

    .output{min-height:280px; padding:1rem; border:1px dashed var(--border); border-radius:12px; background:rgba(2,6,23,.45)}
    .output h4{margin:.25rem 0 .5rem}
    .toolbar{display:flex; gap:.5rem; margin-bottom:.6rem}
    .tool{padding:.5rem .7rem; border:1px solid var(--border); border-radius:10px; background:var(--surface-2); color:var(--text); cursor:pointer}
    .tool:active{transform:translateY(1px)}

    .preview{padding:0; overflow:hidden}
    .preview-head{display:flex; align-items:center; justify-content:space-between; padding:.75rem 1rem; border-bottom:1px solid var(--border)}
    .preview iframe{width:100%; height:420px; border:0; display:block; background:#0b1220}

    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.75rem; border:1px solid var(--border); border-bottom-width:3px; padding:.08rem .35rem; border-radius:6px; background:var(--surface-2)}

    /* --- Tests --- */
    .tests{display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.5rem}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand"><span class="dot"></span><h1>AstroFood Premium Gold</h1></div>
    <div class="actions">
      <span class="badge">Desktop layout</span>
      <span class="badge">v16 Fixed</span>
    </div>
  </header>

  <main class="layout">
    <!-- Sidebar Controls -->
    <aside class="panel sidebar" id="controls">
      <h2>Contr√¥les</h2>
      <div class="field">
        <label>Langue</label>
        <select id="lang">
          <option value="fr">Fran√ßais</option>
          <option value="en">English</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        </select>
        <div class="hint">Astuce¬†: <span class="kbd">L</span> pour basculer rapidement.</div>
      </div>

      <div class="field">
        <label>Votre signe</label>
        <select id="sign">
          <option value="aries">B√©lier</option><option value="taurus">Taureau</option>
          <option value="gemini">G√©meaux</option><option value="cancer">Cancer</option>
          <option value="leo">Lion</option><option value="virgo">Vierge</option>
          <option value="libra">Balance</option><option value="scorpio">Scorpion</option>
          <option value="sagittarius">Sagittaire</option><option value="capricorn">Capricorne</option>
          <option value="aquarius">Verseau</option><option value="pisces">Poissons</option>
        </select>
      </div>

      <div class="row">
        <div class="field">
          <label>Objectif / √âtat</label>
          <select id="state">
            <option value="detox">D√©tox</option>
            <option value="energy_boost">Booster √©nergie</option>
            <option value="stress_relief">Anti-stress</option>
            <option value="immunity">Immunit√©</option>
            <option value="digestion">Digestion</option>
            <option value="metabolic_balance">Balance m√©tabolique</option>
          </select>
        </div>
        <div class="field">
          <label>Plan de repas</label>
          <select id="plan">
            <option value="single">Recette unique</option>
            <option value="daily3">3 repas / jour</option>
          </select>
        </div>
      </div>

      <div class="field">
        <button class="btn primary" id="btn-recipe" type="button">üç≥ G√©n√©rer <span class="hint" style="margin-left:.35rem">(<span class="kbd">Ctrl</span> + <span class="kbd">Entr√©e</span>)</span></button>
      </div>

      <div class="field">
        <a class="btn" id="open-digital-card" href="#" target="previewFrame" rel="noopener">üìá Ouvrir la carte digitale</a>
        <div class="hint">La carte s'ouvre dans l'aper√ßu √† droite.</div>
      </div>

      <div class="tests">
        <button class="tool" id="test-generate">Test¬†: G√©n√©rer (DEMO)</button>
        <button class="tool" id="test-card">Test¬†: Carte (Blob)</button>
      </div>
    </aside>

    <!-- Main Content -->
    <section class="panel content">
      <div class="hero">
        <h3>Assistant Chef‚ÄëAI</h3>
        <p>G√©n√©rez des recettes et plans 3¬†repas adapt√©s √† votre signe et votre objectif.</p>
      </div>

      <div class="work">
        <div>
          <div class="toolbar">
            <button class="tool" id="copy-html">Copier HTML</button>
            <button class="tool" id="clear-output">Effacer</button>
          </div>
          <div id="ai-output" class="output">Pr√™t.</div>
        </div>

        <div class="panel preview">
          <div class="preview-head">
            <div style="opacity:.8">Aper√ßu de la carte digitale</div>
            <div class="hint">Basculer¬†: <span class="kbd">P</span></div>
          </div>
          <iframe id="preview" name="previewFrame" title="Aper√ßu carte"></iframe>
        </div>
      </div>
    </section>
  </main>

  <script>
  (() => {
    if (window.__ASTROFOOD_INIT__) return; window.__ASTROFOOD_INIT__ = true;
    const TEST_MODE = true; // Passez √† false quand l'API est pr√™te

    const $ = s => document.querySelector(s);
    const lang = $('#lang');
    const sign = $('#sign');
    const state = $('#state');
    const plan = $('#plan');
    const out = $('#ai-output');
    const btn = $('#btn-recipe');
    const openCard = $('#open-digital-card');
    const iframe = $('#preview');

    // i18n minimal
    const T = {
      fr:{generating:'üç≥ G√©n√©ration‚Ä¶', error:'‚ùå Erreur de g√©n√©ration', breakfast:'Petit‚Äëd√©jeuner', lunch:'D√©jeuner', dinner:'D√Æner', title_recipe:'Recette', title_plan:'Plan de repas'},
      en:{generating:'üç≥ Generating‚Ä¶', error:'‚ùå Generation error', breakfast:'Breakfast', lunch:'Lunch', dinner:'Dinner', title_recipe:'Recipe', title_plan:'Meal plan'},
      ar:{generating:'üç≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°‚Ä¶', error:'‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°', breakfast:'ŸÅÿ∑Ÿàÿ±', lunch:'ÿ∫ÿØÿßÿ°', dinner:'ÿπÿ¥ÿßÿ°', title_recipe:'ŸàÿµŸÅÿ©', title_plan:'ÿÆÿ∑ÿ© Ÿàÿ¨ÿ®ÿßÿ™'}
    };

    function setLang(code){
      document.documentElement.lang = code;
      document.documentElement.dir = (code === 'ar') ? 'rtl' : 'ltr';
    }
    setLang(lang.value || 'fr');
    lang.addEventListener('change', ()=> setLang(lang.value || 'fr'));

    const API_URL = window.ASTROFOOD_API_URL || '/api/astrofood';
    let busy = false;

    async function generate(){
      if (busy) return; busy = true;
      const lg = lang.value || 'fr';
      const ui = T[lg] || T.fr;
      out.textContent = ui.generating;

      const payload = { lang: lg, sign: sign.value, state: state.value, plan: plan.value, mode: (plan.value === 'daily3') ? 'mealplan' : 'recipe' };

      try{
        if (TEST_MODE){
          if (payload.mode === 'mealplan'){
            out.innerHTML = `
              <h4>${ui.title_plan}</h4>
              <ul>
                <li><strong>${ui.breakfast}:</strong> Omelette astrale aux herbes üåø</li>
                <li><strong>${ui.lunch}:</strong> Salade quinoa‚Äëmangue ‚ú®</li>
                <li><strong>${ui.dinner}:</strong> Saumon citron‚Äëmiel, l√©gumes r√¥tis üåô</li>
              </ul>`;
          } else {
            out.innerHTML = `<h4>${ui.title_recipe}</h4><p>Shake d√©tox citron‚Äëgingembre‚Äëmenthe üçãüå±</p>`;
          }
          busy = false; return;
        }

        const r = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const data = await r.json();
        if (payload.mode === 'mealplan'){
          const b = data && (data.breakfast || '‚Äî');
          const l = data && (data.lunch || '‚Äî');
          const d = data && (data.dinner || '‚Äî');
          out.innerHTML = `<h4>${ui.title_plan}</h4>
            <ul>
              <li><strong>${ui.breakfast}:</strong> ${b}</li>
              <li><strong>${ui.lunch}:</strong> ${l}</li>
              <li><strong>${ui.dinner}:</strong> ${d}</li>
            </ul>`;
        } else {
          const title = (data && (data.title || (data.recipe && data.recipe.title))) || ui.title_recipe;
          const body  = (data && (data.recipe || data.content || data.text || data.body || data.description)) || '‚Äî';
          const text = typeof body === 'string' ? body : (body.recipe || body.content || '‚Äî');
          out.innerHTML = `<h4>${title}</h4><p>${text}</p>`;
        }
      } catch(err){
        console.error(err);
        out.textContent = (T[lang.value]?.error || T.fr.error);
      } finally{ busy = false; }
    }

    btn.addEventListener('click', generate);

    // Raccourcis clavier
    document.addEventListener('keydown', (e)=>{
      if (e.ctrlKey && e.key === 'Enter') { generate(); }
      if (!e.ctrlKey && (e.key === 'l' || e.key === 'L')) { const values = ['fr','en','ar']; const i = values.indexOf(lang.value); lang.value = values[(i+1)%values.length]; lang.dispatchEvent(new Event('change')); }
      if (!e.ctrlKey && (e.key === 'p' || e.key === 'P')) { iframe && iframe.focus(); }
    });

    // ===== CARD PREVIEW via BLOB (√©vite d'inclure un 2e <!DOCTYPE html> dans le m√™me fichier) =====
    function buildCardHTML(params){
      // NB: pas d'inner quotes non √©chapp√©es, pas de retour-ligne non √©chapp√© dans les litt√©raux
      const html = `<!DOCTYPE html><html lang="${params.lang}"><head><meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AstroFood ‚Äì Carte digitale</title>
<style>
:root{--bg: radial-gradient(1200px 600px at 20% -10%, #0f172a 0%, #020617 60%);--surface: rgba(15,23,42,.6);--surface-2: rgba(2,6,23,.65);--border:#1f2937;--text:#e5e7eb;--gold:#FBBF24}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;display:flex;justify-content:center;align-items:flex-start}
.wrap{width:100%;max-width:980px;margin:2rem 1rem}
.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
.head{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.25rem;border-bottom:1px solid var(--border)}
.badge{font-size:.78rem;padding:.25rem .6rem;border:1px solid var(--border);border-radius:999px;opacity:.8}
.section{border:1px dashed var(--border);border-radius:12px;padding:1rem;background:rgba(2,6,23,.45);margin-top:.8rem}
.list{margin:0;padding-left:1.1rem}
.step{display:grid;grid-template-columns:36px 1fr;gap:.6rem;margin:.6rem 0}
.num{width:36px;height:36px;border-radius:10px;background:var(--surface-2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center}
.btn{padding:.6rem .9rem;border-radius:12px;border:1px solid var(--border);background:var(--surface-2);color:var(--text);text-decoration:none;display:inline-flex;gap:.4rem}
.price{font-weight:700;color:var(--gold)}
</style></head><body>
<div class="wrap"><div class="card"><div class="head"><div><strong id="title">Carte digitale</strong></div>
<div><span class="badge" id="bSign"></span> <span class="badge" id="bState"></span> <span class="badge" id="bPlan"></span> <span class="badge" id="bLang"></span></div></div>
<div style="padding:1rem 1.25rem">
  <div class="section"><h3>Ingr√©dients</h3><ul class="list" id="ingredients"></ul></div>
  <div class="section"><h3>Ustensiles</h3><ul class="list" id="equipment"></ul></div>
  <div class="section"><h3>√âtapes</h3><div id="steps"></div></div>
  <div class="section"><h3>Infos</h3><div class="price" id="price"></div><div id="tips" style="margin-top:.4rem;opacity:.85"></div></div>
  <div style="margin-top:.8rem"><a class="btn" id="openSelf" target="_blank" rel="noopener">Ouvrir</a></div>
</div></div></div>
<script>
(function(){
  document.documentElement.lang = ${JSON.stringify(params.lang)};
  document.documentElement.dir = (${JSON.stringify(params.lang)}==='ar')?'rtl':'ltr';
  const API_URL = ${JSON.stringify(window.ASTROFOOD_API_URL || '/api/astrofood')};
  const p = ${JSON.stringify(params)};
  document.getElementById('bSign').textContent = p.sign;
  document.getElementById('bState').textContent = p.state;
  document.getElementById('bPlan').textContent = (p.plan==='daily3')?'3√ó':'1√ó';
  document.getElementById('bLang').textContent = p.lang.toUpperCase();
  document.getElementById('openSelf').href = location.href;
  fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lang:p.lang,sign:p.sign,state:p.state,plan:p.plan,mode:'recipe'})})
    .then(r=>{if(!r.ok) throw new Error('HTTP '+r.status); return r.json();})
    .then(data=>{
      const d = data.recipe || data || {};
      document.getElementById('title').textContent = d.title || 'Recette';
      document.getElementById('price').textContent = d.price_cfa ? (new Intl.NumberFormat('fr-FR').format(d.price_cfa)+' CFA / recette') : '';
      const ing = document.getElementById('ingredients'); (d.ingredients||[]).forEach(it=>{ const li=document.createElement('li'); const qty=(it.qty!==undefined?(it.qty+' '):'')+(it.unit||''); li.textContent=[qty.trim(), it.item, it.notes].filter(Boolean).join(' ‚Ä¢ '); ing.appendChild(li); });
      const eq = document.getElementById('equipment'); (d.equipment||[]).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; eq.appendChild(li); });
      const steps = document.getElementById('steps'); (d.steps||[]).forEach((s,i)=>{ const row=document.createElement('div'); row.className='step'; const mins=s.timer_sec? Math.round(s.timer_sec/60):null; row.innerHTML='<div class="num">'+(s.n||i+1)+'</div><div>'+ (s.text||'') + (mins?'<div style="opacity:.75">‚è≤Ô∏è '+mins+' min</div>':'') + (s.heat?'<div style="opacity:.75">üî• '+s.heat+'</div>':'') + '</div>'; steps.appendChild(row); });
      const tips = d.tips && d.tips.length ? ('‚Ä¢ '+ d.tips.join('\n‚Ä¢ ')) : '';
      document.getElementById('tips').textContent = tips;
    })
    .catch(e=>{ document.getElementById('steps').innerHTML = '<p>‚ùå Impossible de charger la recette.</p>'; console.error(e); });
})();

  </script>
</body>
</html>
