<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AstroFood Premium Gold ‚Äî Chef-AI (vFinal)</title>
  <meta name="description" content="AstroFood Premium Gold: recettes IA par signe (FR/EN/AR), Chef-AI, carte digitale, QR WhatsApp." />
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --gold:#FBBF24; --bg1:#0f172a; --bg2:#020617; --glass:rgba(255,255,255,0.04);
      --muted:#cbd5e1; --round:12px; --maxw:980px; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Cairo", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(circle at 20% 10%, #091028 0%, var(--bg1) 30%, var(--bg2) 100%); color:#fff}
    .wrap{max-width:var(--maxw);margin:28px auto;padding:24px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));box-shadow:0 6px 30px rgba(2,6,23,0.6)}
    header{display:flex;align-items:center;gap:16px}
    .logo{width:56px;height:56px;border-radius:8px;background:linear-gradient(135deg,var(--gold),#f59e0b);display:flex;align-items:center;justify-content:center;font-weight:700;color:#041025}
    h1{margin:0;font-size:20px}
    .top-right{margin-left:auto;font-size:13px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:330px 1fr;gap:18px;margin-top:18px}
    .panel{background:var(--glass);padding:14px;border-radius:var(--round);backdrop-filter: blur(6px);min-height:120px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    select, button, .chip, input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}
    .row{display:flex;gap:8px}
    .row>*{flex:1}
    .muted{color:var(--muted);font-size:13px}
    .btn-primary{background:linear-gradient(90deg,var(--gold),#f59e0b);color:#041025;font-weight:600;border:none;cursor:pointer}
    .btn-outline{background:transparent;border:1px solid rgba(255,255,255,0.06);cursor:pointer}
    .recipe-out{padding:14px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));min-height:220px;overflow:auto}
    .card-preview{padding:12px;border-radius:10px;background:linear-gradient(90deg, rgba(11,19,40,0.6), rgba(3,6,10,0.4));min-height:260px}
    .card-title{font-weight:700;color:var(--gold);font-size:16px}
    .qr{width:88px;height:88px;border-radius:8px;background:#fff;padding:6px}
    .card-image{width:100%;height:140px;border-radius:8px;object-fit:cover;background:#061022;margin-bottom:8px}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
    @media (max-width:880px){.grid{grid-template-columns:1fr}.top-right{display:none}}
    .rtl{direction:rtl;font-family:Cairo, "Segoe UI", system-ui}
  </style>

  <!-- html2canvas CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <div class="wrap" role="main">
    <header>
      <div class="logo">AF</div>
      <div>
        <h1 id="ui-title">AstroFood ‚Äî Premium Gold (Chef-AI)</h1>
        <div class="muted" id="ui-sub">Recettes et cartes digitales par signe astrologique ‚Äî FR / EN / AR</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <div style="width:140px">
          <label id="lbl-ui-lang">Langue interface</label>
          <select id="ui-lang" aria-label="Langue interface">
            <option value="fr">FR</option>
            <option value="en">EN</option>
            <option value="ar">AR</option>
          </select>
        </div>
        <div class="top-right muted" id="version-badge">vFinal ¬∑ Premium Gold</div>
      </div>
    </header>

    <section class="grid" aria-label="Contr√¥les et aper√ßu">
      <div class="panel" id="controls">
        <div style="margin-bottom:10px">
          <label id="lbl-sign">Choisir un signe</label>
          <select id="sign" aria-label="Signe astrologique">
            <option value="aries">B√©lier / Aries</option>
            <option value="taurus">Taureau / Taurus</option>
            <option value="gemini">G√©meaux / Gemini</option>
            <option value="cancer">Cancer</option>
            <option value="leo">Lion / Leo</option>
            <option value="virgo">Vierge / Virgo</option>
            <option value="libra">Balance / Libra</option>
            <option value="scorpio">Scorpion / Scorpio</option>
            <option value="sagittarius">Sagit. / Sagittarius</option>
            <option value="capricorn">Capricorne / Capricorn</option>
            <option value="aquarius">Verseau / Aquarius</option>
            <option value="pisces">Poissons / Pisces</option>
          </select>
        </div>

        <div style="margin-bottom:10px">
          <label id="lbl-meal">Type de repas</label>
          <div class="row">
            <select id="meal" aria-label="Type de repas">
              <option value="breakfast">Petit-d√©j / Breakfast</option>
              <option value="lunch">D√©jeuner / Lunch</option>
              <option value="dinner">D√Æner / Dinner</option>
            </select>
            <select id="lang-recipe" aria-label="Langue recette">
              <option value="fr">FR</option>
              <option value="en">EN</option>
              <option value="ar">AR</option>
            </select>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:6px">
          <button id="btn-generate" class="btn-primary">üç≥ G√©n√©rer la recette</button>
          <button id="open-digital-card" class="btn-outline">üìá Afficher la carte digitale</button>
        </div>

        <div style="margin-top:12px">
          <label id="lbl-chef">Chef-AI Chat</label>
          <div style="display:flex;gap:8px">
            <input id="chef-query" placeholder="Demande au Chef-AI (ex: variante v√©g√©tarienne)" />
            <button id="chef-send" class="btn-outline">Envoyer</button>
          </div>
          <div id="chef-response" class="muted" style="margin-top:8px;min-height:46px">R√©ponse Chef-AI ici...</div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <label id="lbl-contact">QR / Contact</label>
            <div style="display:flex;gap:8px">
              <img id="qr-img" class="qr" alt="QR code WhatsApp" src="" />
              <div style="flex:1">
                <div class="muted" id="lbl-qr-help">QR WhatsApp / site</div>
                <div style="margin-top:6px">
                  <input id="contact-number" placeholder="+221786599051" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="export-png" class="btn-primary">‚¨á Exporter carte PNG</button>
          <button id="export-png-high" class="btn-outline">‚¨Ü PNG haute r√©solution</button>
        </div>
      </div>

      <div>
        <div class="panel" style="margin-bottom:12px">
          <div style="display:flex;gap:12px;align-items:flex-start">
            <div style="flex:1">
              <label id="lbl-recipe-output">Recette g√©n√©r√©e</label>
              <div id="recipe" class="recipe-out" role="region" aria-live="polite">
                <div class="muted" id="recipe-placeholder">Appuie sur "G√©n√©rer la recette" pour commencer ‚Äî la recette s'adaptera au signe, au repas et √† la langue.</div>
              </div>
            </div>

            <div style="width:320px">
              <label id="lbl-card-preview">Carte digitale (aper√ßu)</label>
              <div id="card" class="card-preview" role="region" aria-label="Carte digitale preview">
                <div id="card-inner" style="color:#fff">
                  <img id="card-image" class="card-image" src="" alt="Photo recette" />
                  <div id="card-content">
                    <div class="card-title" id="card-title">AstroFood ¬∑ Carte digitale</div>
                    <div id="card-ingredients" class="muted" style="font-size:13px;margin-top:6px">Ingr√©dients: ...</div>
                    <div id="card-prep" style="margin-top:8px;font-size:13px">Pr√©paration: ...</div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                      <div id="card-cook" class="muted" style="font-size:12px">Cuisson: --</div>
                      <div id="card-cals" class="muted" style="font-size:12px">Calories: --</div>
                    </div>
                  </div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:end;margin-top:8px">
                  <small class="muted">vFinal ¬∑ Premium Gold</small>
                  <button id="download-card" class="btn-outline" style="width:auto">‚¨á Export (imprimer)</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="panel">
          <label id="lbl-examples">Historique / Exemples africains</label>
          <div id="examples" class="muted" style="min-height:110px;overflow:auto;padding:6px"></div>
        </div>
      </div>
    </section>

    <footer>
      <small id="ui-footer">AstroFood ‚Äî Premium Gold ¬∑ Connecte Chef-AI √† /api/chef-ai pour r√©ponses r√©elles.</small>
    </footer>
  </div>

  <script>
  // ---------- UI TEXTS ----------
  const UI_TEXT = {
    fr:{ title:"AstroFood ‚Äî Premium Gold (Chef-AI)", sub:"Recettes et cartes digitales ‚Äî FR/EN/AR",
         lblUiLang:"Langue interface", lblSign:"Choisir un signe", lblMeal:"Type de repas",
         btnGenerate:"üç≥ G√©n√©rer la recette", btnOpenCard:"üìá Afficher la carte digitale",
         lblChef:"Chef-AI Chat", btnChefSend:"Envoyer", lblContact:"QR / Contact", lblQrHelp:"QR WhatsApp / site",
         btnExport:"‚¨á Exporter carte PNG", btnExportHigh:"‚¨Ü PNG haute r√©solution",
         lblRecipeOutput:"Recette g√©n√©r√©e", lblCardPreview:"Carte digitale (aper√ßu)", lblExamples:"Exemples africains",
         uiFooter:"AstroFood ‚Äî Premium Gold ¬∑ Connecte Chef-AI √† /api/chef-ai pour r√©ponses r√©elles." },
    en:{ title:"AstroFood ‚Äî Premium Gold (Chef-AI)", sub:"Recipes and digital cards ‚Äî FR/EN/AR",
         lblUiLang:"Interface language", lblSign:"Choose a sign", lblMeal:"Meal type",
         btnGenerate:"üç≥ Generate recipe", btnOpenCard:"üìá Show digital card",
         lblChef:"Chef-AI Chat", btnChefSend:"Send", lblContact:"QR / Contact", lblQrHelp:"WhatsApp QR / site",
         btnExport:"‚¨á Export card PNG", btnExportHigh:"‚¨Ü High-res PNG",
         lblRecipeOutput:"Generated recipe", lblCardPreview:"Digital card (preview)", lblExamples:"African examples",
         uiFooter:"AstroFood ‚Äî Premium Gold ¬∑ Connect Chef-AI to /api/chef-ai for real answers." },
    ar:{ title:"ÿ£ÿ≥ÿ™ÿ±ŸàŸÅŸàÿØ ‚Äî ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿ∞Ÿáÿ®Ÿäÿ© (Chef-AI)", sub:"ŸàÿµŸÅÿßÿ™ Ÿàÿ®ÿ∑ÿßŸÇÿßÿ™ ÿ±ŸÇŸÖŸäÿ© ‚Äî FR/EN/AR",
         lblUiLang:"ŸÑÿ∫ÿ© ÿßŸÑŸàÿßÿ¨Ÿáÿ©", lblSign:"ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ÿ±ÿ¨", lblMeal:"ŸÜŸàÿπ ÿßŸÑŸàÿ¨ÿ®ÿ©",
         btnGenerate:"üç≥ ÿßŸÜÿ¥ÿ¶ ÿßŸÑŸàÿµŸÅÿ©", btnOpenCard:"üìá ÿπÿ±ÿ∂ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ±ŸÇŸÖŸäÿ©",
         lblChef:"ÿ¥ŸäŸÅ-ÿ¢Ÿä ÿ¥ÿßÿ™", btnChefSend:"ÿ•ÿ±ÿ≥ÿßŸÑ", lblContact:"ÿ±ŸÖÿ≤ ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ÿßŸÑÿ≥ÿ±Ÿäÿπÿ© / ÿ™ŸàÿßÿµŸÑ", lblQrHelp:"QR Ÿàÿßÿ™ÿ≥ÿßÿ® / ÿßŸÑŸÖŸàŸÇÿπ",
         btnExport:"‚¨á ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© PNG", btnExportHigh:"‚¨Ü PNG ÿ¨ŸàÿØÿ© ÿπÿßŸÑŸäÿ©",
         lblRecipeOutput:"ÿßŸÑŸàÿµŸÅÿ© ÿßŸÑŸÖŸàŸÑÿØÿ©", lblCardPreview:"ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ±ŸÇŸÖŸäÿ© (ŸÖÿπÿßŸäŸÜÿ©)", lblExamples:"ÿ£ŸÖÿ´ŸÑÿ© ÿ•ŸÅÿ±ŸäŸÇŸäÿ©",
         uiFooter:"ÿ£ÿ≥ÿ™ÿ±ŸàŸÅŸàÿØ ‚Äî ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿ∞Ÿáÿ®Ÿäÿ© ¬∑ ÿßÿ±ÿ®ÿ∑ Chef-AI ÿ®ŸÜŸÇÿ∑ÿ© /api/chef-ai ŸÑŸÑÿ±ÿØŸàÿØ ÿßŸÑÿ≠ŸÇŸäŸÇŸäÿ©." }
  };

  // ---------- SAMPLE RECIPES (fallback local) ----------
 // ---------- SAMPLE RECIPES (fix) ----------
const SAMPLE_RECIPES = {
  fr: {
    breakfast: [
      {
        title: "Bowl √©nergie (africain)",
        desc: "Bouillie de fonio, banane, miel local, graines de s√©same.",
        ingredients: ["Fonio 100g", "1 banane", "1 c.√† soupe miel", "1 c.√† soupe graines de s√©same"],
        preparation: "Cuire le fonio 10 min. M√©langer avec la banane, le miel et les graines.",
        cook: "Cuisson: 10 min",
        calories: "‚âà350 kcal",
        imgSeed: "fonio-bowl"
      }
    ],
    lunch: [
      {
        title: "Yassa v√©g√©tarien l√©ger",
        desc: "Oignons caram√©lis√©s, citron, riz complet.",
        ingredients: ["Oignons 2", "Citron", "Riz complet 150g", "L√©gumes grill√©s"],
        preparation: "Caram√©liser les oignons, ajouter citron, cuire riz, servir.",
        cook: "Cuisson: 25-30 min",
        calories: "‚âà520 kcal",
        imgSeed: "yassa-veg"
      }
    ],
    dinner: [
      {
        title: "Soupe douce de patate",
        desc: "Patate douce, gingembre, lait de coco.",
        ingredients: ["Patate douce 300g", "1 c.√† caf√© gingembre", "200ml lait de coco"],
        preparation: "Cuire 20 min, mixer, servir chaud.",
        cook: "Cuisson: 20 min",
        calories: "‚âà300 kcal",
        imgSeed: "sweetpotato-soup"
      }
    ]
  }
};

// Maintenant, apr√®s avoir cr√©√© SAMPLE_RECIPES.fr, on affecte en et ar
SAMPLE_RECIPES.en = {
  breakfast: SAMPLE_RECIPES.fr.breakfast,
  lunch: SAMPLE_RECIPES.fr.lunch,
  dinner: SAMPLE_RECIPES.fr.dinner
};

SAMPLE_RECIPES.ar = {
  breakfast: SAMPLE_RECIPES.fr.breakfast,
  lunch: SAMPLE_RECIPES.fr.lunch,
  dinner: SAMPLE_RECIPES.fr.dinner
};

  // ---------- HELPERS & DOM ----------
  function elt(q){return document.querySelector(q)}
  const uiLangEl = elt('#ui-lang'), signEl = elt('#sign'), mealEl = elt('#meal'), langRecipeEl = elt('#lang-recipe');
  const btnGenerate = elt('#btn-generate'), recipeOut = elt('#recipe'), cardImage = elt('#card-image'), cardTitle = elt('#card-title');
  const cardIngredients = elt('#card-ingredients'), cardPrep = elt('#card-prep'), cardCook = elt('#card-cook'), cardCals = elt('#card-cals');
  const openCardBtn = elt('#open-digital-card'), downloadCardBtn = elt('#download-card'), qrImg = elt('#qr-img'), contactNumber = elt('#contact-number');
  const exportPngBtn = elt('#export-png'), exportPngHighBtn = elt('#export-png-high'), chefQuery = elt('#chef-query'), chefSend = elt('#chef-send'), chefResp = elt('#chef-response');
  const examplesEl = elt('#examples');

  const uiNodes = {
    title: elt('#ui-title'), sub: elt('#ui-sub'), lblUiLang: elt('#lbl-ui-lang'),
    lblSign: elt('#lbl-sign'), lblMeal: elt('#lbl-meal'), btnGenerate: elt('#btn-generate'),
    btnOpenCard: elt('#open-digital-card'), lblChef: elt('#lbl-chef'), btnChefSend: elt('#chef-send'),
    lblContact: elt('#lbl-contact'), lblQrHelp: elt('#lbl-qr-help'), btnExport: elt('#export-png'),
    btnExportHigh: elt('#export-png-high'), lblRecipeOutput: elt('#lbl-recipe-output'),
    lblCardPreview: elt('#lbl-card-preview'), lblExamples: elt('#lbl-examples'), uiFooter: elt('#ui-footer')
  };

  // set UI language
  function setUiLanguage(lang){
    const t = UI_TEXT[lang] || UI_TEXT.fr;
    uiNodes.title.textContent = t.title; uiNodes.sub.textContent = t.sub;
    uiNodes.lblUiLang.textContent = t.lblUiLang; uiNodes.lblSign.textContent = t.lblSign; uiNodes.lblMeal.textContent = t.lblMeal;
    uiNodes.btnGenerate.textContent = t.btnGenerate; uiNodes.btnOpenCard.textContent = t.btnOpenCard; uiNodes.lblChef.textContent = t.lblChef;
    uiNodes.btnChefSend.textContent = t.btnChefSend; uiNodes.lblContact.textContent = t.lblContact; uiNodes.lblQrHelp.textContent = t.lblQrHelp;
    uiNodes.btnExport.textContent = t.btnExport; uiNodes.btnExportHigh.textContent = t.btnExportHigh;
    uiNodes.lblRecipeOutput.textContent = t.lblRecipeOutput; uiNodes.lblCardPreview.textContent = t.lblCardPreview;
    uiNodes.lblExamples.textContent = t.lblExamples; uiNodes.uiFooter.textContent = t.uiFooter;
    if(lang==='ar'){document.documentElement.dir='rtl'; document.body.classList.add('rtl')} else {document.documentElement.dir='ltr'; document.body.classList.remove('rtl')}
  }
  setUiLanguage(uiLangEl.value);
  uiLangEl.addEventListener('change', ()=> setUiLanguage(uiLangEl.value));

  // QR
  function updateQR(){ const num = (contactNumber.value||'+221786599051').trim().replace(/\D/g,''); const wa = encodeURIComponent('https://wa.me/'+num); qrImg.src='https://chart.googleapis.com/chart?cht=qr&chs=180x180&chl='+wa; qrImg.alt='QR '+num}
  contactNumber.addEventListener('input', updateQR); updateQR();

  // examples
  function populateExamples(){ const lines=[]; lines.push('<strong>Recettes exemples :</strong>'); (SAMPLE_RECIPES.fr.breakfast || []).forEach(r=> lines.push(`<div style="margin-top:8px"><b>${r.title}</b><div style="font-size:13px;color:#cbd5e1">${r.desc}</div></div>`)); examplesEl.innerHTML = lines.join('') }
  populateExamples();

  // image util
  function imageFor(seed,w=800,h=500){ const s = encodeURIComponent(seed||'astrofood'); return `https://picsum.photos/seed/${s}/${w}/${h}` }

  // pick local fallback
  function pickRecipeLocal({lang,meal,sign}){
    const bucket=(SAMPLE_RECIPES[lang]&&SAMPLE_RECIPES[lang][meal])?SAMPLE_RECIPES[lang][meal]:SAMPLE_RECIPES.fr.breakfast;
    const idx=(Array.from(sign).reduce((s,c)=>s+c.charCodeAt(0),0))%bucket.length;
    const base=bucket[idx];
    const title = `${base.title}`;
    return {
      title, desc: base.desc, ingredients: base.ingredients||[], preparation: base.preparation||'', cook: base.cook||'', calories: base.calories||'', img:imageFor(base.imgSeed||base.title+sign+meal)
    };
  }

  // render recipe UI + sync card
 // Remplace enti√®rement ta fonction renderRecipeToUI par ceci
function renderRecipeToUI(recipe, uiLang='fr'){
  const isAr = uiLang === 'ar';

  // card text labels selon langue
  const labels = {
    ingredients: isAr ? 'ÿßŸÑŸÖŸÉŸàŸÜÿßÿ™' : (uiLang === 'en' ? 'Ingredients' : 'Ingr√©dients'),
    preparation: isAr ? 'ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ™ÿ≠ÿ∂Ÿäÿ±' : (uiLang === 'en' ? 'Preparation' : 'Pr√©paration'),
    cook: isAr ? 'ÿßŸÑÿ∑ÿ®ÿÆ' : (uiLang === 'en' ? 'Cook' : 'Cuisson'),
    calories: isAr ? 'ÿßŸÑÿ≥ÿπÿ±ÿßÿ™' : (uiLang === 'en' ? 'Calories' : 'Calories')
  };

  // build recipe HTML (main recipe output area)
  let html = '';
  if (isAr) {
    html += `<div class="rtl" style="font-family:Cairo, sans-serif">`;
    html += `<div style="font-weight:700;font-size:15px;margin-bottom:8px">${escapeHtml(recipe.title)}</div>`;
    html += `<div style="font-size:14px;margin-bottom:8px">${escapeHtml(recipe.desc)}</div>`;
    html += `<div style="font-weight:600;margin-top:6px">${labels.ingredients}:</div>`;
    html += `<ul style="padding-right:18px; padding-left:0; text-align:right">` + (recipe.ingredients || []).map(i=>`<li style="margin-bottom:6px">${escapeHtml(i)}</li>`).join('') + `</ul>`;
    html += `<div style="font-weight:600;margin-top:6px">${labels.preparation}:</div><div style="margin-top:6px">${escapeHtml(recipe.preparation)}</div>`;
    html += `<div style="margin-top:8px">${escapeHtml(recipe.cook)} ¬∑ ${escapeHtml(recipe.calories)}</div>`;
    html += `</div>`;
  } else {
    html += `<div>`;
    html += `<div style="font-weight:700;font-size:15px;margin-bottom:8px">${escapeHtml(recipe.title)}</div>`;
    html += `<div style="font-size:14px;margin-bottom:8px">${escapeHtml(recipe.desc)}</div>`;
    html += `<div style="font-weight:600;margin-top:6px">${labels.ingredients}:</div>`;
    html += `<ul style="padding-left:18px">` + (recipe.ingredients || []).map(i=>`<li style="margin-bottom:6px">${escapeHtml(i)}</li>`).join('') + `</ul>`;
    html += `<div style="font-weight:600;margin-top:6px">${labels.preparation}:</div><div style="margin-top:6px">${escapeHtml(recipe.preparation)}</div>`;
    html += `<div style="margin-top:8px">${escapeHtml(recipe.cook)} ¬∑ ${escapeHtml(recipe.calories)}</div>`;
    html += `</div>`;
  }

  recipeOut.innerHTML = html;

  // update card preview (image + card content)
  cardImage.src = recipe.img || imageFor(recipe.title);
  cardImage.alt = recipe.title || '';

  // When Arabic, set RTL styles on the card and align text right
  const cardEl = document.getElementById('card-inner');
  if (isAr) {
    cardEl.style.direction = 'rtl';
    cardEl.style.textAlign = 'right';
    cardTitle.style.fontFamily = 'Cairo, sans-serif';
  } else {
    cardEl.style.direction = 'ltr';
    cardEl.style.textAlign = 'left';
    cardTitle.style.fontFamily = '';
  }

  // set title (recipe title may already be in Arabic from the model)
  cardTitle.textContent = recipe.title || 'AstroFood ¬∑ Carte digitale';

  // Build ingredients line (short) and preparation snippet for card
  const ingrShort = (recipe.ingredients || []).slice(0,6).join(', ');
  cardIngredients.innerHTML = `<strong>${isAr ? 'ÿßŸÑŸÖŸÉŸàŸÜÿßÿ™' : (uiLang === 'en' ? 'Ingredients' : 'Ingr√©dients')}:</strong> ${escapeHtml(ingrShort)}`;
  cardPrep.innerHTML = `<strong>${isAr ? 'ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ™ÿ≠ÿ∂Ÿäÿ±' : (uiLang === 'en' ? 'Preparation' : 'Pr√©paration')}:</strong> ${escapeHtml((recipe.preparation||'').slice(0,120))}`;
  cardCook.textContent = recipe.cook || '--';
  cardCals.textContent = recipe.calories || '--';

  // small accessibility: set lang attribute on the card for screen readers
  const cardWrapper = document.getElementById('card');
  if (isAr) {
    cardWrapper.setAttribute('lang','ar');
  } else if (uiLang === 'en') {
    cardWrapper.setAttribute('lang','en');
  } else {
    cardWrapper.setAttribute('lang','fr');
  }
}


  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

  // generate local fallback or call server optionally
  btnGenerate.addEventListener('click', async ()=>{
    btnGenerate.disabled=true; btnGenerate.textContent = UI_TEXT[uiLangEl.value].btnGenerate.replace('üç≥','üç≥ G√©n√©ration‚Ä¶');
    try {
      // local fallback generation
      const recipe = pickRecipeLocal({ lang: langRecipeEl.value, meal: mealEl.value, sign: signEl.value });
      await new Promise(r => setTimeout(r, 300));
      renderRecipeToUI(recipe, uiLangEl.value);
    } catch(err){
      recipeOut.innerHTML = `<div class="muted">Erreur lors de la g√©n√©ration.</div>`; console.error(err);
    } finally {
      btnGenerate.disabled=false; btnGenerate.textContent = UI_TEXT[uiLangEl.value].btnGenerate;
    }
  });

  // printable card
  openCardBtn.addEventListener('click', ()=>{
    const cardHtml = `<html><head><meta charset="utf-8"/><title>Carte AstroFood</title><style>body{margin:20px;font-family:Inter, Arial;background:#081025;color:#fff} .wrap{background:linear-gradient(90deg,#061026 0%,#03101a 100%);padding:20px;border-radius:12px;max-width:600px}</style></head><body><div class="wrap">${document.getElementById('card').innerHTML}</div></body></html>`;
    const w = window.open('','_blank');
    if(w){ w.document.open(); w.document.write(cardHtml); w.document.close(); } else alert('Popup bloqu√©e ‚Äî autorise les popups.');
  });
  downloadCardBtn.addEventListener('click', ()=> openCardBtn.click());

  // export PNG with html2canvas
  async function exportCardPNG(scale=1){
    const cardEl = document.getElementById('card');
    try {
      const canvas = await html2canvas(cardEl, { scale: scale, useCORS:true, backgroundColor:null, scrollY:-window.scrollY });
      const dataUrl = canvas.toDataURL('image/png');
      const a = document.createElement('a'); a.href=dataUrl; a.download = `${(cardTitle.textContent||'astrofood-card').replace(/\s+/g,'_')}.png`; document.body.appendChild(a); a.click(); a.remove();
    } catch(err){ console.error('html2canvas error', err); alert('Erreur export PNG: ' + (err.message||err)) }
  }
  exportPngBtn.addEventListener('click', async ()=>{
    exportPngBtn.disabled=true; exportPngBtn.textContent = '‚¨á Exporting‚Ä¶'; try{ await exportCardPNG(1) } finally{ exportPngBtn.disabled=false; exportPngBtn.textContent = UI_TEXT[uiLangEl.value].btnExport }
  });
  exportPngHighBtn.addEventListener('click', async ()=>{
    exportPngHighBtn.disabled=true; exportPngHighBtn.textContent = '‚¨Ü Exporting‚Ä¶'; try{ await exportCardPNG(2) } finally{ exportPngHighBtn.disabled=false; exportPngHighBtn.textContent = UI_TEXT[uiLangEl.value].btnExportHigh }
  });

  // Chef-AI client handler (calls /api/chef-ai)
  chefSend.addEventListener('click', async ()=>{
    const q = (chefQuery.value||'').trim();
    if(!q){ chefResp.textContent = uiLangEl.value==='fr' ? '√âcris une question pour le Chef-AI.' : (uiLangEl.value==='en' ? 'Write a question for Chef-AI.' : 'ÿßŸÉÿ™ÿ® ÿ≥ÿ§ÿßŸÑÿßŸã ŸÑŸÑÿ¥ŸäŸÅ.'); return; }
    const CHEF_API_URL = '/api/chef-ai';
    chefSend.disabled=true; chefResp.textContent = uiLangEl.value==='fr' ? 'Chef-AI r√©fl√©chit‚Ä¶' : (uiLangEl.value==='en' ? 'Chef-AI thinking‚Ä¶' : 'ÿßŸÑÿ¥ŸäŸÅ ŸäŸÅŸÉÿ±‚Ä¶');
    const payload = { prompt:q, sign:signEl.value, meal:mealEl.value, lang:langRecipeEl.value };
    const controller = new AbortController(); const TIMEOUT_MS=20000; const timeoutId = setTimeout(()=>controller.abort(), TIMEOUT_MS);
    try {
      const res = await fetch(CHEF_API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload), signal:controller.signal });
      clearTimeout(timeoutId);
      if(!res.ok){
        let text=''; try{text=await res.text()}catch(_){}
        chefResp.textContent = (uiLangEl.value==='fr' ? 'Erreur serveur: ' : (uiLangEl.value==='en' ? 'Server error: ' : 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿÆÿßÿØŸÖ: ')) + `${res.status}${text ? ' ‚Äî '+text : ''}`;
        return;
      }
      let data; try{ data = await res.json() } catch(e){ chefResp.textContent = uiLangEl.value==='fr' ? 'R√©ponse invalide du serveur.' : (uiLangEl.value==='en' ? 'Invalid server response.' : 'ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ÿÆÿßÿØŸÖ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©.'); return; }
      if(data.answer) chefResp.textContent = data.answer; else chefResp.textContent = uiLangEl.value==='fr' ? 'Pas de r√©ponse du Chef-AI.' : (uiLangEl.value==='en' ? 'No answer from Chef-AI.' : 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ¨ÿßÿ®ÿ© ŸÖŸÜ ÿßŸÑÿ¥ŸäŸÅ.');
      if(data.recipe && typeof data.recipe==='object'){ const r = { title:data.recipe.title||'', desc:data.recipe.desc||'', ingredients:Array.isArray(data.recipe.ingredients)?data.recipe.ingredients:(data.recipe.ingredients? [String(data.recipe.ingredients)]:[]), preparation:data.recipe.preparation||'', cook:data.recipe.cook||'', calories:data.recipe.calories||'', img:data.recipe.img||'' }; if(r.img) try{ r.img = (new URL(r.img, window.location.href)).href }catch(_){ } renderRecipeToUI(r, uiLangEl.value); }
    } catch(err){
      if(err.name==='AbortError') chefResp.textContent = uiLangEl.value==='fr' ? 'D√©lai d√©pass√© (timeout).' : (uiLangEl.value==='en' ? 'Request timed out.' : 'ÿßŸÜÿ™Ÿáÿ™ ŸÖŸáŸÑÿ© ÿßŸÑÿ∑ŸÑÿ®.');
      else chefResp.textContent = (uiLangEl.value==='fr' ? 'Erreur Chef-AI: ' : (uiLangEl.value==='en' ? 'Chef-AI error: ' : 'ÿÆÿ∑ÿ£ ÿßŸÑÿ¥ŸäŸÅ: ')) + (err.message||err);
      console.error('Chef-AI client error', err);
    } finally { chefSend.disabled=false; clearTimeout(timeoutId); }
  });

  // ctrl/cmd+G shortcut
  document.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='g' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); btnGenerate.click(); } });

  // initial sample
  (function initial(){ const rec = pickRecipeLocal({ lang:'fr', meal:'breakfast', sign:'aries' }); renderRecipeToUI(rec, uiLangEl.value); })();   
    
</script>
</body>
</html>
