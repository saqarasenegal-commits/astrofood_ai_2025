<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AstroFood Premium Gold ‚Äî Index (Dark Astral)</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --bg: radial-gradient(1200px 600px at 20% -10%, #0f172a 0%, #020617 60%);
      --surface: rgba(15,23,42,.6);
      --surface-2: rgba(2,6,23,.65);
      --border: #1f2937;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --gold:#FBBF24;
      --accent:#38bdf8;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    *,*:before,*:after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans, sans-serif; display:flex; flex-direction:column}

    /* Topbar */
    .topbar{display:flex; align-items:center; justify-content:space-between; padding:.9rem 1.25rem; border-bottom:1px solid var(--border); background:linear-gradient(to bottom, rgba(2,6,23,.9), rgba(2,6,23,.6)); position:sticky; top:0; z-index:30; backdrop-filter: blur(6px)}
    .brand{display:flex; align-items:center; gap:.75rem}
    .brand .dot{width:10px; height:10px; border-radius:50%; background:var(--gold); box-shadow:0 0 0 6px rgba(251,191,36,.15)}
    .brand h1{font-size:1.05rem; margin:0; letter-spacing:.4px; color:var(--gold)}
    .actions{display:flex; align-items:center; gap:.5rem}
    .badge{font-size:.75rem; opacity:.75; border:1px solid var(--border); padding:.25rem .5rem; border-radius:999px}

    /* Layout */
    .layout{display:grid; grid-template-columns: 340px 1fr; gap:1.25rem; padding:1.25rem; width:100%; max-width:1280px; margin:0 auto; flex:1}
    @media (max-width: 960px){ .layout{grid-template-columns:1fr} }
    .panel{background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}

    /* Sidebar */
    .sidebar{padding:1rem}
    .sidebar h2{font-size:1rem; margin:.25rem 0 1rem; color:var(--muted)}
    .field{margin-bottom:1rem}
    .field label{display:block; margin-bottom:.4rem; font-size:.9rem; color:var(--muted)}
    select, .btn{width:100%; padding:.7rem .85rem; border-radius:12px; border:1px solid var(--border); background:var(--surface-2); color:var(--text); outline:none}
    select:focus{border-color:var(--accent); box-shadow:0 0 0 4px rgba(56,189,248,.15)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:.75rem}
    .btn.primary{background:var(--gold); color:#111827; border:none; font-weight:700; cursor:pointer}
    .btn.primary:active{transform:translateY(1px)}
    .hint{font-size:.82rem; color:var(--muted); margin-top:.35rem}

    /* Content */
    .content{display:flex; flex-direction:column}
    .hero{padding:1rem 1.25rem; border-bottom:1px solid var(--border)}
    .hero h3{margin:.2rem 0 .35rem; color:var(--gold)}
    .hero p{margin:0; color:var(--muted)}

    .work{display:grid; grid-template-columns: 1fr 420px; gap:1rem; padding:1rem}
    @media (max-width: 1200px){ .work{grid-template-columns:1fr} }

    .output{min-height:280px; padding:1rem; border:1px dashed var(--border); border-radius:12px; background:rgba(2,6,23,.45)}
    .output h4{margin:.25rem 0 .5rem}
    .toolbar{display:flex; gap:.5rem; margin-bottom:.6rem}
    .tool{padding:.5rem .7rem; border:1px solid var(--border); border-radius:10px; background:var(--surface-2); color:var(--text); cursor:pointer}
    .tool:active{transform:translateY(1px)}

    .preview{padding:0; overflow:hidden}
    .preview-head{display:flex; align-items:center; justify-content:space-between; padding:.75rem 1rem; border-bottom:1px solid var(--border)}
    .preview iframe{width:100%; height:420px; border:0; display:block; background:#0b1220}

    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.75rem; border:1px solid var(--border); border-bottom-width:3px; padding:.08rem .35rem; border-radius:6px; background:var(--surface-2)}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand"><span class="dot"></span><h1>AstroFood Premium Gold</h1></div>
    <div class="actions">
      <span class="badge">Dark Astral</span>
      <span class="badge">v16.4</span>
    </div>
  </header>

  <main class="layout">
    <!-- Sidebar Controls -->
    <aside class="panel sidebar" id="controls">
      <h2 id="lbl-controls">Contr√¥les</h2>

      <div class="field">
        <label for="lang" id="lbl-lang">Langue</label>
        <select id="lang">
          <option value="fr">Fran√ßais</option>
          <option value="en">English</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        </select>
        <div class="hint" id="hint-lang">Astuce¬†: <span class="kbd">L</span> pour basculer rapidement.</div>
      </div>

      <div class="field">
        <label for="sign" id="lbl-sign">Votre signe</label>
        <select id="sign">
          <option value="aries">B√©lier</option><option value="taurus">Taureau</option>
          <option value="gemini">G√©meaux</option><option value="cancer">Cancer</option>
          <option value="leo">Lion</option><option value="virgo">Vierge</option>
          <option value="libra">Balance</option><option value="scorpio">Scorpion</option>
          <option value="sagittarius">Sagittaire</option><option value="capricorn">Capricorne</option>
          <option value="aquarius">Verseau</option><option value="pisces">Poissons</option>
        </select>
      </div>

      <div class="row">
        <div class="field">
          <label for="state" id="lbl-state">Objectif / √âtat</label>
          <select id="state">
            <option value="detox">D√©tox</option>
            <option value="energy_boost">Booster √©nergie</option>
            <option value="stress_relief">Anti-stress</option>
            <option value="immunity">Immunit√©</option>
            <option value="digestion">Digestion</option>
            <option value="metabolic_balance">Balance m√©tabolique</option>
          </select>
        </div>
        <div class="field">
          <label for="plan" id="lbl-plan">Plan de repas</label>
          <select id="plan">
            <option value="single">Recette unique</option>
            <option value="daily3">3 repas / jour</option>
          </select>
        </div>
      </div>

      <div class="field">
        <button class="btn primary" id="btn-recipe" type="button">üç≥ <span id="btn-generate-label">G√©n√©rer</span></button>
      </div>

      <div class="field">
        <a class="btn" id="open-digital-card" href="/card.html" target="_blank" rel="noopener">üìá <span id="btn-card-label">Ouvrir la carte digitale</span></a>
        <div class="hint" id="hint-card">La carte s'ouvre dans un nouvel onglet.</div>
      </div>
    </aside>

    <!-- Main Content -->
    <section class="panel content">
      <div class="hero">
        <h3 id="hero-title">Assistant Chef‚ÄëAI</h3>
        <p id="hero-desc">G√©n√©rez des recettes et plans 3¬†repas adapt√©s √† votre signe et votre objectif.</p>
      </div>

      <div class="work">
        <div>
          <div class="toolbar">
            <button class="tool" id="copy-html">Copier HTML</button>
            <button class="tool" id="clear-output">Effacer</button>
          </div>
          <div id="ai-output" class="output">Pr√™t.</div>
        </div>

        <div class="panel preview">
          <div class="preview-head">
            <div style="opacity:.8" id="preview-title">Aper√ßu de la carte (ouvrir dans un onglet)</div>
            <div class="hint" id="preview-hint">Raccourcis¬†: <span class="kbd">Ctrl</span>+<span class="kbd">Entr√©e</span> pour g√©n√©rer</div>
          </div>
          <iframe id="preview" title="Aper√ßu carte" srcdoc="<html><body style='margin:0;background:#0b1220;color:#94a3b8;font-family:system-ui;display:flex;align-items:center;justify-content:center;height:100%'>Cliquez ‚ÄòOuvrir la carte digitale‚Äô</body></html>"></iframe>
        </div>
      </div>
    </section>
  </main>

  <script>
  (() => {
    if (window.__ASTROFOOD_INIT__) return; window.__ASTROFOOD_INIT__ = true;
    const TEST_MODE = false; // mettre true pour d√©mo locale

    const $ = s => document.querySelector(s);
    const lang = $('#lang');
    const sign = $('#sign');
    const state = $('#state');
    const plan = $('#plan');
    const out = $('#ai-output');
    const btn = $('#btn-recipe');
    const openCard = $('#open-digital-card');

    // i18n labels
    const I18N = {
      fr: {
        controls: 'Contr√¥les', lang: 'Langue', hintLang: 'Astuce¬†: L pour basculer rapidement.',
        sign: 'Votre signe', state: 'Objectif / √âtat', plan: 'Plan de repas',
        generate: 'G√©n√©rer', card: 'Ouvrir la carte digitale', hintCard: "La carte s'ouvre dans un nouvel onglet.",
        heroTitle: 'Assistant Chef‚ÄëAI', heroDesc: 'G√©n√©rez des recettes et plans 3 repas adapt√©s √† votre signe et votre objectif.',
        generating: 'üç≥ G√©n√©ration‚Ä¶', error: '‚ùå Erreur de g√©n√©ration',
        previewTitle: 'Aper√ßu de la carte (ouvrir dans un onglet)', previewHint: 'Raccourcis¬†: Ctrl+Entr√©e pour g√©n√©rer'
      },
      en: {
        controls: 'Controls', lang: 'Language', hintLang: 'Tip: press L to switch quickly.',
        sign: 'Your sign', state: 'Goal / State', plan: 'Meal plan',
        generate: 'Generate', card: 'Open digital card', hintCard: 'The card opens in a new tab.',
        heroTitle: 'Chef‚ÄëAI Assistant', heroDesc: 'Generate recipes and 3‚Äëmeal plans tailored to your sign and goal.',
        generating: 'üç≥ Generating‚Ä¶', error: '‚ùå Generation error',
        previewTitle: 'Card preview (open in a new tab)', previewHint: 'Shortcuts: Ctrl+Enter to generate'
      },
      ar: {
        controls: 'ÿßŸÑÿ™ÿ≠ŸÉŸÖ', lang: 'ÿßŸÑŸÑÿ∫ÿ©', hintLang: 'ŸÜÿµŸäÿ≠ÿ©: ÿßÿ∂ÿ∫ÿ∑ L ŸÑŸÑÿ™ÿ®ÿØŸäŸÑ ÿ®ÿ≥ÿ±ÿπÿ©.',
        sign: 'ÿ®ÿ±ÿ¨ŸÉ', state: 'ÿßŸÑŸáÿØŸÅ / ÿßŸÑÿ≠ÿßŸÑÿ©', plan: 'ÿÆÿ∑ÿ© ÿßŸÑŸàÿ¨ÿ®ÿßÿ™',
        generate: 'ÿ•ŸÜÿ¥ÿßÿ°', card: 'ŸÅÿ™ÿ≠ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ±ŸÇŸÖŸäÿ©', hintCard: 'ÿ™ŸÅÿ™ÿ≠ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ŸÅŸä ÿπŸÑÿßŸÖÿ© ÿ™ÿ®ŸàŸäÿ® ÿ¨ÿØŸäÿØÿ©.',
        heroTitle: 'ŸÖÿ≥ÿßÿπÿØ ÿßŸÑÿ¥ŸäŸÅ‚ÄëAI', heroDesc: 'ÿ£ŸÜÿ¥ÿ¶ ŸàÿµŸÅÿßÿ™ ŸàÿÆÿ∑ÿ∑ Ÿ£ Ÿàÿ¨ÿ®ÿßÿ™ ÿ≠ÿ≥ÿ® ÿ®ÿ±ÿ¨ŸÉ ŸàŸáÿØŸÅŸÉ.',
        generating: 'üç≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°‚Ä¶', error: '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°',
        previewTitle: 'ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© (ÿßŸÅÿ™ÿ≠ ŸÅŸä ÿπŸÑÿßŸÖÿ© ÿ™ÿ®ŸàŸäÿ®)', previewHint: 'ÿßÿÆÿ™ÿµÿßÿ±: Ctrl+Enter ŸÑŸÑÿ•ŸÜÿ¥ÿßÿ°'
      }
    };

    function applyI18N(code){
      const t = I18N[code] || I18N.fr;
      $('#lbl-controls').textContent = t.controls;
      $('#lbl-lang').textContent = t.lang; $('#hint-lang').textContent = t.hintLang;
      $('#lbl-sign').textContent = t.sign; $('#lbl-state').textContent = t.state; $('#lbl-plan').textContent = t.plan;
      $('#btn-generate-label').textContent = t.generate;
      $('#btn-card-label').textContent = t.card; $('#hint-card').textContent = t.hintCard;
      $('#hero-title').textContent = t.heroTitle; $('#hero-desc').textContent = t.heroDesc;
      $('#preview-title').textContent = t.previewTitle; $('#preview-hint').textContent = t.previewHint;
      document.documentElement.lang = code; document.documentElement.dir = (code === 'ar') ? 'rtl' : 'ltr';
    }
    applyI18N(lang.value || 'fr');

    lang.addEventListener('change', ()=> applyI18N(lang.value || 'fr'));

    const API_URL = window.ASTROFOOD_API_URL || '/api/astrofood';
    let busy = false;

    async function generate(){
      if (busy) return; busy = true;
      const code = lang.value || 'fr';
      const t = I18N[code] || I18N.fr;
      out.textContent = t.generating;

      const payload = { lang: code, sign: sign.value, state: state.value, plan: plan.value, mode: (plan.value === 'daily3') ? 'mealplan' : 'recipe' };

      try{
        if (TEST_MODE){
          if (payload.mode === 'mealplan'){
            out.innerHTML = `<h4>${t.plan}</h4>
              <ul>
                <li><strong>Petit‚Äëd√©jeuner:</strong> Omelette astrale aux herbes üåø</li>
                <li><strong>D√©jeuner:</strong> Salade quinoa‚Äëmangue ‚ú®</li>
                <li><strong>D√Æner:</strong> Saumon citron‚Äëmiel, l√©gumes r√¥tis üåô</li>
              </ul>`;
          } else {
            out.innerHTML = `<h4>Recette</h4><p>Shake d√©tox citron‚Äëgingembre‚Äëmenthe üçãüå±</p>`;
          }
          busy=false; return;
        }

        const r = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const data = await r.json();

        if (payload.mode === 'mealplan'){
          const b = data?.breakfast || '‚Äî';
          const l = data?.lunch || '‚Äî';
          const d = data?.dinner || '‚Äî';
          out.innerHTML = `<h4>${t.plan}</h4>
            <ul>
              <li><strong>Breakfast / Petit‚Äëd√©j:</strong> ${b}</li>
              <li><strong>Lunch / D√©jeuner:</strong> ${l}</li>
              <li><strong>Dinner / D√Æner:</strong> ${d}</li>
            </ul>`;
        } else {
          const title = data?.title || data?.recipe?.title || 'Recette';
          const body  = data?.recipe || data?.content || data?.text || '‚Äî';
          const text = (typeof body === 'string') ? body : (body?.recipe || body?.content || '‚Äî');
          out.innerHTML = `<h4>${title}</h4><p>${text}</p>`;
        }
      } catch(err){
        console.error(err);
        out.textContent = (I18N[lang.value]?.error || I18N.fr.error);
      } finally { busy=false; }
    }

    btn.addEventListener('click', generate);

    // Shortcuts: Ctrl+Enter generate, L switch language
    document.addEventListener('keydown', (e)=>{
      if (e.ctrlKey && e.key === 'Enter') generate();
      if (!e.ctrlKey && (e.key === 'l' || e.key === 'L')){
        const values = ['fr','en','ar'];
        const i = values.indexOf(lang.value);
        lang.value = values[(i+1)%values.length];
        lang.dispatchEvent(new Event('change'));
      }
    });

    // Build card.html URL with params on click
    function cardURL(){
      const params = new URLSearchParams({ sign:sign.value, lang:lang.value, state:state.value, plan:plan.value });
      const base = openCard.getAttribute('href') || '/card.html';
      const url = new URL(base, window.location.origin);
      url.search = params.toString();
      return url.toString();
    }

    openCard.addEventListener('click', (e)=>{
      // keep target="_blank" behaviour, just ensure URL has params
      openCard.setAttribute('href', cardURL());
    });

    // Copy helpers
    $('#copy-html').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(out.innerHTML.trim()); alert('HTML copi√© ‚úÖ'); }
      catch(err){ alert('Impossible de copier'); }
    });
    $('#clear-output').addEventListener('click', ()=>{ out.textContent = 'Pr√™t.'; });
  })();
  </script>
</body>
</html>
